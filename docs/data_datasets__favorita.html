---

title: Favorita retail dataset


keywords: fastai
sidebar: home_sidebar



nb_path: "nbs/data_datasets__favorita.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/data_datasets__favorita.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># !pip install matplotlib</span>
<span class="c1"># !pip install sklearn</span>
<span class="c1"># !pip install pydantic</span>
<span class="c1"># !pip install shutil</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><a name="cell-1"></a></p>
<h2 id="1.-Auxiliary-Functions">1. Auxiliary Functions<a class="anchor-link" href="#1.-Auxiliary-Functions"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="CodeTimer" class="doc_header"><code>class</code> <code>CodeTimer</code><a href="https://github.com/Nixtla/neuralforecast/tree/main/neuralforecast/data/datasets/favorita.py#L48" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>CodeTimer</code>(<strong><code>name</code></strong>=<em><code>None</code></em>, <strong><code>verbose</code></strong>=<em><code>True</code></em>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="check_nans" class="doc_header"><code>check_nans</code><a href="https://github.com/Nixtla/neuralforecast/tree/main/neuralforecast/data/datasets/favorita.py#L63" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>check_nans</code>(<strong><code>df</code></strong>)</p>
</blockquote>
<p>For data wrangling logs</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="check_items" class="doc_header"><code>check_items</code><a href="https://github.com/Nixtla/neuralforecast/tree/main/neuralforecast/data/datasets/favorita.py#L79" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>check_items</code>(<strong><code>items</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="one_hot_encoding" class="doc_header"><code>one_hot_encoding</code><a href="https://github.com/Nixtla/neuralforecast/tree/main/neuralforecast/data/datasets/favorita.py#L84" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>one_hot_encoding</code>(<strong><code>df</code></strong>, <strong><code>index_col</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="nonzero_indexes_by_row" class="doc_header"><code>nonzero_indexes_by_row</code><a href="https://github.com/Nixtla/neuralforecast/tree/main/neuralforecast/data/datasets/favorita.py#L96" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>nonzero_indexes_by_row</code>(<strong><code>M</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="numpy_balance" class="doc_header"><code>numpy_balance</code><a href="https://github.com/Nixtla/neuralforecast/tree/main/neuralforecast/data/datasets/favorita.py#L99" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>numpy_balance</code>(<strong>*<code>arrs</code></strong>)</p>
</blockquote>
<p>Fast NumPy implementation of balance function.
The function creates all the interactions between
the NumPy arrays provided.</p>

<pre><code>Parameters
----------
arrs: NumPy arrays
Returns
-------
out: NumPy array</code></pre>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="numpy_ffill" class="doc_header"><code>numpy_ffill</code><a href="https://github.com/Nixtla/neuralforecast/tree/main/neuralforecast/data/datasets/favorita.py#L116" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>numpy_ffill</code>(<strong><code>arr</code></strong>)</p>
</blockquote>
<p>Fast NumPy implementation of forwardfill function.
The function fills missing/nan values with the
following value in the array.</p>

<pre><code>Parameters
----------
arr: NumPy array
Returns
-------
arr: NumPy array</code></pre>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="numpy_bfill" class="doc_header"><code>numpy_bfill</code><a href="https://github.com/Nixtla/neuralforecast/tree/main/neuralforecast/data/datasets/favorita.py#L134" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>numpy_bfill</code>(<strong><code>arr</code></strong>)</p>
</blockquote>
<p>Fast NumPy implementation of backfill function.
The function fills missing/nan values with the
previous value in the array.</p>

<pre><code>Parameters
----------
arr: NumPy array
Returns
-------
arr: NumPy array</code></pre>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="distance_to_holiday" class="doc_header"><code>distance_to_holiday</code><a href="https://github.com/Nixtla/neuralforecast/tree/main/neuralforecast/data/datasets/favorita.py#L153" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>distance_to_holiday</code>(<strong><code>holiday_dates</code></strong>, <strong><code>dates</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="make_holidays_distance_df" class="doc_header"><code>make_holidays_distance_df</code><a href="https://github.com/Nixtla/neuralforecast/tree/main/neuralforecast/data/datasets/favorita.py#L184" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>make_holidays_distance_df</code>(<strong><code>holidays_df</code></strong>, <strong><code>dates</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><a name="cell-2"></a></p>
<h2 id="2.-Favorita-Class">2. Favorita Class<a class="anchor-link" href="#2.-Favorita-Class"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="Favorita" class="doc_header"><code>class</code> <code>Favorita</code><a href="https://github.com/Nixtla/neuralforecast/tree/main/neuralforecast/data/datasets/favorita.py#L200" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>Favorita</code>(<strong><code>S</code></strong>:<code>DataFrame</code>, <strong><code>X</code></strong>:<code>DataFrame</code>, <strong><code>Y</code></strong>:<code>DataFrame</code>, <strong><code>idx_categorical_static</code></strong>:<code>Optional</code>[<code>List</code>[<code>T</code>]]=<em><code>None</code></em>, <strong><code>group</code></strong>:<code>Union</code>[<code>str</code>, <code>List</code>[<code>str</code>]]=<em><code>None</code></em>) :: <a href="/neuralforecast/data_datasets__utils.html#TimeSeriesDataclass"><code>TimeSeriesDataclass</code></a></p>
</blockquote>
<p>Favorita(S: pandas.core.frame.DataFrame, X: pandas.core.frame.DataFrame, Y: pandas.core.frame.DataFrame, idx_categorical_static: Union[List, NoneType] = None, group: Union[str, List[str]] = None)</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><a name="cell-3"></a></p>
<h2 id="3.-Favorita-Validation">3. Favorita Validation<a class="anchor-link" href="#3.-Favorita-Validation"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="3.1-Load-and-Process-data">3.1 Load and Process data<a class="anchor-link" href="#3.1-Load-and-Process-data"> </a></h3>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Favorita.preprocess_data(directory=directory, sample_size=100, verbose=False)</span>
<span class="c1"># data = Favorita.load_process(directory=directory, sample_size=100, verbose=True)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="3.2-Validate-data-with-plots.">3.2 Validate data with plots.<a class="anchor-link" href="#3.2-Validate-data-with-plots."> </a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Checking-Hierarchical-aggregation-matrix">Checking Hierarchical aggregation matrix<a class="anchor-link" href="#Checking-Hierarchical-aggregation-matrix"> </a></h4>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span> 
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># plt.spy(data[&#39;H&#39;])</span>
<span class="c1"># plt.show()</span>
<span class="c1"># plt.close()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Checking-pre-estimated-levels-seasons-S_bottom">Checking pre-estimated levels seasons S_bottom<a class="anchor-link" href="#Checking-pre-estimated-levels-seasons-S_bottom"> </a></h4>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># X = data[&#39;X&#39;]</span>
<span class="c1"># xcols = data[&#39;xcols&#39;]</span>
<span class="c1"># item_idx = 10</span>
<span class="c1"># store_idx = 31</span>

<span class="c1"># # Target variable (unit sales)</span>
<span class="c1"># unitsales_idx = xcols.get_loc(&#39;unit_sales&#39;)</span>

<span class="c1"># plt.figure(figsize=(12, 1.8))</span>
<span class="c1"># plt.plot(dates, X[item_idx, store_idx, unitsales_idx, :-1])</span>
<span class="c1"># plt.ylabel(&#39;Unit Sales&#39;)</span>
<span class="c1"># plt.xlabel(&#39;Date&#39;)</span>
<span class="c1"># plt.show()</span>
<span class="c1"># plt.close()</span>

<span class="c1"># # On promotion</span>
<span class="c1"># onpromotion_idx = xcols.get_loc(&#39;onpromotion&#39;)</span>

<span class="c1"># plt.figure(figsize=(12, 1.8))</span>
<span class="c1"># plt.plot(dates, X[item_idx, store_idx, onpromotion_idx, :-1])</span>
<span class="c1"># plt.ylabel(&#39;On Promotion \n [Indicator]&#39;)</span>
<span class="c1"># plt.xlabel(&#39;Date&#39;)</span>
<span class="c1"># plt.show()</span>
<span class="c1"># plt.close()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Checking-S/Y/X_agg">Checking S/Y/X_agg<a class="anchor-link" href="#Checking-S/Y/X_agg"> </a></h4>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># xcols_agg = data[&#39;xcols_agg&#39;]</span>
<span class="c1"># dates = data[&#39;dates&#39;]</span>

<span class="c1"># # Plot oil temporal exogenous</span>
<span class="c1"># item_idx =0</span>
<span class="c1"># oil_idx = xcols_agg.get_loc(&#39;dcoilwtico&#39;)</span>

<span class="c1"># plt.figure(figsize=(12, 1.8))</span>
<span class="c1"># plt.plot(dates, X_agg[item_idx, oil_idx, :-1])</span>
<span class="c1"># plt.ylabel(&#39;Oil Price Index&#39;)</span>
<span class="c1"># plt.xlabel(&#39;Date&#39;)</span>
<span class="c1"># plt.show()</span>
<span class="c1"># plt.close()</span>

<span class="c1"># # Plot calendar variables</span>
<span class="c1"># day_of_week_idx = xcols_agg.get_loc(&#39;day_of_week&#39;)</span>
<span class="c1"># day_of_month_idx = xcols_agg.get_loc(&#39;day_of_month&#39;)</span>
<span class="c1"># month_idx = xcols_agg.get_loc(&#39;month&#39;)</span>

<span class="c1"># plt.figure(figsize=(12, 1.8))</span>
<span class="c1"># plt.plot(dates[-400:], X_agg[item_idx, day_of_week_idx, -401:-1], label=&#39;day_of_week&#39;)</span>
<span class="c1"># plt.plot(dates[-400:], X_agg[item_idx, day_of_month_idx, -401:-1], label=&#39;day_of_month&#39;)</span>
<span class="c1"># plt.plot(dates[-400:], X_agg[item_idx, month_idx, -401:-1], label=&#39;month&#39;)</span>
<span class="c1"># plt.legend(bbox_to_anchor=(1, 1), loc=&#39;upper left&#39;, ncol=1)</span>
<span class="c1"># plt.ylabel(&#39;Calendar Variables&#39;)</span>
<span class="c1"># plt.xlabel(&#39;Date&#39;)</span>
<span class="c1"># plt.show()</span>
<span class="c1"># plt.close()</span>

<span class="c1"># # Plot holidays</span>
<span class="c1"># holidays = [&#39;dist2_[Primer dia del ano]&#39;, &#39;dist2_[Carnaval]&#39;, &#39;dist2_[Viernes Santo]&#39;, </span>
<span class="c1">#             &#39;dist2_[Dia del Trabajo]&#39;, &#39;dist2_[Batalla de Pichincha]&#39;, </span>
<span class="c1">#             &#39;dist2_[Primer Grito de Independencia]&#39;, </span>
<span class="c1">#             &#39;dist2_[Traslado Independencia de Guayaquil]&#39;, &#39;dist2_[Dia de Difuntos]&#39;, </span>
<span class="c1">#             &#39;dist2_[Independencia de Cuenca]&#39;, &#39;dist2_[Navidad]&#39;, </span>
<span class="c1">#             &#39;dist2_[Independencia de Guayaquil]&#39;, &#39;dist2_[Traslado Batalla de Pichincha]&#39;, </span>
<span class="c1">#             &#39;dist2_[Traslado Primer Grito de Independencia]&#39;, &#39;dist2_[Traslado Primer dia del ano]&#39;,]</span>

<span class="c1"># plt.figure(figsize=(12, 1.8))</span>
<span class="c1"># for holiday in holidays:</span>
<span class="c1">#     holiday_idx = xcols_agg.get_loc(holiday)</span>
<span class="c1">#     plt.plot(dates[-400:], X_agg[item_idx, holiday_idx, -401:-1])</span>
<span class="c1"># plt.ylabel(&#39;Holiday Distance \n [in days]&#39;)</span>
<span class="c1"># plt.xlabel(&#39;Date&#39;)</span>
<span class="c1"># plt.show()</span>
<span class="c1"># plt.close()</span>

<span class="c1"># # Plot total store transactions</span>
<span class="c1"># storeA = &#39;transactions_store_[41]&#39;</span>
<span class="c1"># storeB = &#39;transactions_store_[2]&#39;</span>
<span class="c1"># storeA_idx = xcols_agg.get_loc(storeA)</span>
<span class="c1"># storeB_idx = xcols_agg.get_loc(storeB)</span>

<span class="c1"># plt.figure(figsize=(12, 1.8))</span>
<span class="c1"># plt.plot(X_agg[item_idx, storeA_idx, :-1], label=storeA)</span>
<span class="c1"># plt.plot(X_agg[item_idx, storeB_idx, :-1], label=storeB)</span>
<span class="c1"># plt.ylabel(&#39;Open/Closed store \n [Indicator]&#39;)</span>
<span class="c1"># plt.xlabel(&#39;Date&#39;)</span>
<span class="c1"># plt.legend(bbox_to_anchor=(1, 1), loc=&#39;upper left&#39;, ncol=1)</span>
<span class="c1"># plt.show()</span>
<span class="c1"># plt.close()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Checking-Hierarchically-linked-data">Checking Hierarchically linked data<a class="anchor-link" href="#Checking-Hierarchically-linked-data"> </a></h4>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">plot_hierarchically_linked_data</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">item_idx</span><span class="p">,</span> <span class="n">store_idx</span><span class="p">,</span> 
                                    <span class="n">n_days</span><span class="o">=</span><span class="mi">30</span><span class="o">*</span><span class="mi">5</span><span class="p">,</span> <span class="n">plot_file</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    
    <span class="c1"># This plots validate the S/X/Y_bottom</span>
    <span class="c1"># We check for the sinchronization of features with Y_bottom</span>
    <span class="c1"># We do the same for Y_agg, to check correct linkage</span>
    <span class="k">assert</span> <span class="n">store_idx</span> <span class="o">&lt;</span> <span class="mi">94</span> <span class="ow">and</span> <span class="n">store_idx</span><span class="o">&gt;=</span><span class="mi">0</span>
    
    <span class="c1"># Hierarchically linked target data and labels</span>
    <span class="c1"># [Total, State, City] [0, 1, 2]</span>
    <span class="n">linked_idxs</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;hier_linked_idxs&#39;</span><span class="p">][</span><span class="n">store_idx</span><span class="p">]</span>
    
    <span class="c1"># Base series and its label idx \in {0,...,304}</span>
    <span class="c1"># n_agg=1+16+22=39</span>
    <span class="n">Y_hier</span>  <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Y_hier&#39;</span><span class="p">][</span><span class="n">item_idx</span><span class="p">,</span> <span class="p">:,:]</span>
    <span class="n">Y_base</span>  <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Y_hier&#39;</span><span class="p">][</span><span class="n">item_idx</span><span class="p">,</span> <span class="n">store_idx</span><span class="o">+</span><span class="mi">39</span><span class="p">,:]</span>
    <span class="n">Y_base2</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Y&#39;</span><span class="p">][</span><span class="n">item_idx</span><span class="p">,</span><span class="n">store_idx</span><span class="p">,:]</span>
    
    <span class="n">hier_labels</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;hier_labels&#39;</span><span class="p">]</span>
    <span class="n">label</span>       <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;items_ids&#39;</span><span class="p">][</span><span class="n">item_idx</span><span class="p">]</span>
        
    <span class="n">x_plot</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;dates&#39;</span><span class="p">][:]</span> <span class="c1">#-12] # Skip future dates</span>
    
    <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">linked_idxs</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span> <span class="c1">#9</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">linked_idx</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">linked_idxs</span><span class="p">):</span>
        <span class="n">axs</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_plot</span><span class="p">[</span><span class="o">-</span><span class="n">n_days</span><span class="p">:],</span> <span class="n">Y_hier</span><span class="p">[</span><span class="n">linked_idx</span><span class="p">,</span><span class="o">-</span><span class="n">n_days</span><span class="p">:],</span>
                      <span class="n">color</span><span class="o">=</span><span class="s1">&#39;#628793&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>
        <span class="n">plot_label</span> <span class="o">=</span> <span class="n">hier_labels</span><span class="p">[</span><span class="n">linked_idx</span><span class="p">]</span>
        <span class="n">plot_label</span> <span class="o">=</span> <span class="n">plot_label</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;[&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">plot_label</span> <span class="o">=</span> <span class="n">plot_label</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;]&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">plot_label</span> <span class="o">=</span> <span class="n">plot_label</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="s1">&#39;: &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">title</span><span class="p">()</span>
        <span class="n">axs</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">plot_label</span><span class="si">}</span><span class="s1">  </span><span class="se">\n</span><span class="s1"> [unit demand]&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">13</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">13</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">linked_idxs</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">axs</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
    
    <span class="c1"># Checking that Y_bottom and Y_hier match</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_plot</span><span class="p">[</span><span class="o">-</span><span class="n">n_days</span><span class="p">:],</span> <span class="n">Y_base</span><span class="p">[</span><span class="o">-</span><span class="n">n_days</span><span class="p">:],</span>
                <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;base&#39;</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_plot</span><span class="p">[</span><span class="o">-</span><span class="n">n_days</span><span class="p">:],</span> <span class="n">Y_base2</span><span class="p">[</span><span class="o">-</span><span class="n">n_days</span><span class="p">:],</span>
                <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;base2&#39;</span><span class="p">)</span>
    
    <span class="n">axs</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">13</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">plot_label</span><span class="si">}</span><span class="s1"> </span><span class="se">\n</span><span class="s1"> [unit demand]&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">13</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">13</span><span class="p">)</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Hierarchically Linked Series for Item </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">top</span><span class="o">=</span><span class="mf">0.95</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">plot_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">plot_file</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    
<span class="c1"># item_idx  = 0</span>
<span class="c1"># store_idx = 31</span>
<span class="c1"># plot_hierarchically_linked_data(data=data, </span>
<span class="c1">#                                 item_idx=item_idx, store_idx=store_idx, </span>
<span class="c1">#                                 n_days=30*6, plot_file=None)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Checking-Geographically-linked-data">Checking Geographically linked data<a class="anchor-link" href="#Checking-Geographically-linked-data"> </a></h4>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><a name="cell-4"></a></p>
<h2 id="4.-HierTimeseriesDataset-Validation">4. HierTimeseriesDataset Validation<a class="anchor-link" href="#4.-HierTimeseriesDataset-Validation"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># from neuralforecast.data.datasets.favorita import Favorita</span>
<span class="c1"># from neuralforecast.data.hiertsdataset import HierTimeseriesDataset</span>

<span class="c1"># directory = &#39;./data/hierarchical/favorita&#39;</span>
<span class="c1"># Favorita.preprocess_data(directory=directory, sample_size=100, verbose=False)</span>
<span class="c1"># data = Favorita.load_process(directory=directory, sample_size=100, verbose=True)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># H = 34</span>

<span class="c1"># train_dataset = HierTimeseriesDataset(# Bottom data</span>
<span class="c1">#                                       X=data[&#39;X&#39;], </span>
<span class="c1">#                                       S=data[&#39;S&#39;], </span>
<span class="c1">#                                       Y=data[&#39;Y&#39;],</span>
<span class="c1">#                                       xcols=data[&#39;xcols&#39;],</span>
<span class="c1">#                                       xcols_hist=data[&#39;xcols_hist&#39;],</span>
<span class="c1">#                                       xcols_futr=data[&#39;xcols_futr&#39;],</span>
<span class="c1">#                                       xcols_sample_mask=data[&#39;xcols_sample_mask&#39;],</span>
<span class="c1">#                                       xcols_available_mask=data[&#39;xcols_available_mask&#39;],</span>
<span class="c1">#                                       dates = data[&#39;dates&#39;],</span>
<span class="c1">#                                       # Aggregated data</span>
<span class="c1">#                                       X_agg=data[&#39;X_agg&#39;], </span>
<span class="c1">#                                       S_agg=data[&#39;S_agg&#39;], </span>
<span class="c1">#                                       Y_agg=data[&#39;Y_agg&#39;],</span>
<span class="c1">#                                       xcols_agg=data[&#39;xcols_agg&#39;],</span>
<span class="c1">#                                       xcols_hist_agg=data[&#39;xcols_hist_agg&#39;],</span>
<span class="c1">#                                       xcols_futr_agg=data[&#39;xcols_futr_agg&#39;],</span>
<span class="c1">#                                       # Generator parameters</span>
<span class="c1">#                                       T0=0,T=T,H=H)</span>

<span class="c1"># valid_dataset = HierTimeseriesDataset(# Bottom data</span>
<span class="c1">#                                       X=data[&#39;X&#39;], </span>
<span class="c1">#                                       S=data[&#39;S&#39;], </span>
<span class="c1">#                                       Y=data[&#39;Y&#39;],</span>
<span class="c1">#                                       xcols=data[&#39;xcols&#39;],</span>
<span class="c1">#                                       xcols_hist=data[&#39;xcols_hist&#39;],</span>
<span class="c1">#                                       xcols_futr=data[&#39;xcols_futr&#39;],</span>
<span class="c1">#                                       xcols_sample_mask=data[&#39;xcols_sample_mask&#39;],</span>
<span class="c1">#                                       xcols_available_mask=data[&#39;xcols_available_mask&#39;], </span>
<span class="c1">#                                       dates = data[&#39;dates&#39;],</span>
<span class="c1">#                                       # Aggregated data</span>
<span class="c1">#                                       X_agg=data[&#39;X_agg&#39;], </span>
<span class="c1">#                                       S_agg=data[&#39;S_agg&#39;], </span>
<span class="c1">#                                       Y_agg=data[&#39;Y_agg&#39;],</span>
<span class="c1">#                                       xcols_agg=data[&#39;xcols_agg&#39;],</span>
<span class="c1">#                                       xcols_hist_agg=data[&#39;xcols_hist_agg&#39;],</span>
<span class="c1">#                                       xcols_futr_agg=data[&#39;xcols_futr_agg&#39;],</span>
<span class="c1">#                                       # Generator parameters</span>
<span class="c1">#                                       T0=24,T=T,H=H,</span>
<span class="c1">#                                       lastwindow_mask=True)</span>

<span class="c1"># train_dataloader = DataLoader(train_dataset, batch_size=4, shuffle=True, num_workers=0)</span>
<span class="c1"># valid_dataloader = DataLoader(valid_dataset, batch_size=4, shuffle=False, num_workers=0)</span>

<span class="c1"># train_batch = next(iter(train_dataloader))</span>
<span class="c1"># valid_batch = next(iter(valid_dataloader))</span>

<span class="c1"># for key in train_batch.keys():</span>
<span class="c1">#     print(f&#39;{key}.shape&#39;, train_batch[key].shape)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="4.1-Examinate-HierTimeSeriesDataset-aggregate-batch">4.1 Examinate HierTimeSeriesDataset aggregate batch<a class="anchor-link" href="#4.1-Examinate-HierTimeSeriesDataset-aggregate-batch"> </a></h3><ol>
<li>Examinate the hierarchically linked Y_agg series.</li>
<li>Examinate the alignment between Y_agg and X_agg_futr.</li>
<li>Validate the S_agg dummies generated from H constraints matrix.</li>
</ol>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># batch = valid_batch</span>
<span class="c1"># S_agg = batch[&#39;S_agg&#39;][0]</span>
<span class="c1"># Y_agg = batch[&#39;Y_agg&#39;][0]</span>
<span class="c1"># X_agg = batch[&#39;X_agg&#39;][0]</span>
<span class="c1"># F_agg = batch[&#39;F_agg&#39;][0]</span>

<span class="c1"># print(&#39;S_agg.shape&#39;, S_agg.shape)</span>
<span class="c1"># print(&#39;Y_agg.shape&#39;, Y_agg.shape)</span>
<span class="c1"># print(&#39;X_agg.shape&#39;, X_agg.shape)</span>
<span class="c1"># print(&#39;F_agg.shape&#39;, F_agg.shape)</span>

<span class="c1"># #---------------- Hierarchical Y_agg ----------------#</span>
<span class="c1"># plt.plot(Y_agg[0,:])</span>
<span class="c1"># plt.plot(Y_agg[1,:])</span>
<span class="c1"># plt.plot(Y_agg[2,:])</span>
<span class="c1"># plt.plot(Y_agg[3,:])</span>
<span class="c1"># plt.title(&#39;Y_agg&#39;)</span>
<span class="c1"># plt.show()</span>
<span class="c1"># plt.close()</span>

<span class="c1"># #---------------- X_agg_futr ----------------#</span>
<span class="c1"># F_agg = np.maximum(F_agg[0,:]*80000,</span>
<span class="c1">#                    np.zeros(F_agg[0,:].shape))</span>
<span class="c1"># plt.plot(F_agg[-36:])</span>
<span class="c1"># plt.plot(Y_agg[0,-36:])</span>
<span class="c1"># plt.title(&#39;F_agg&#39;)</span>
<span class="c1"># plt.show()</span>
<span class="c1"># plt.close()</span>

<span class="c1"># #---------------- S_agg ----------------#</span>
<span class="c1"># plt.figure(num=1, figsize=(5, 5), dpi=80, facecolor=&#39;w&#39;)</span>
<span class="c1"># plt.spy(S_agg[None,:])</span>
<span class="c1"># plt.title(&#39;S_agg&#39;)</span>
<span class="c1"># plt.show()</span>
<span class="c1"># plt.close()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="4.2-Examinate-HierTimeSeriesDataset-bottom-batch">4.2 Examinate HierTimeSeriesDataset bottom batch<a class="anchor-link" href="#4.2-Examinate-HierTimeSeriesDataset-bottom-batch"> </a></h3><ol>
<li>Examinate the alignment between Y_bottom, S_bottom and X_bottom_futr.</li>
<li>Validate batch Seq2Seq structure between X_bottom vs Y_bottom.</li>
</ol>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># # batch = train_batch</span>
<span class="c1"># # dates = train_dataset.dates</span>
<span class="c1"># batch = valid_batch</span>
<span class="c1"># dates = valid_dataset.dates</span>
<span class="c1"># S_bottom = batch[&#39;S&#39;][0]</span>
<span class="c1"># Y_bottom = batch[&#39;Y&#39;][0]</span>
<span class="c1"># X_bottom = batch[&#39;X&#39;][0]</span>
<span class="c1"># F_bottom = batch[&#39;F&#39;][0]</span>
<span class="c1"># sample_mask = batch[&#39;sample_mask&#39;][0]</span>

<span class="c1"># print(&#39;S_bottom.shape&#39;, S_bottom.shape)</span>
<span class="c1"># print(&#39;Y_bottom.shape&#39;, Y_bottom.shape)</span>
<span class="c1"># print(&#39;X_bottom.shape&#39;, X_bottom.shape)</span>
<span class="c1"># print(&#39;F_bottom.shape&#39;, F_bottom.shape)</span>

<span class="c1"># #---------------- Y/S/X_bottom alignment ----------------#</span>
<span class="c1"># n_years = 3</span>
<span class="c1"># fig, axs = plt.subplots(4,1, figsize=(12, 9))</span>

<span class="c1"># for idx, purpose in enumerate([&#39;Hol&#39;, &#39;Vis&#39;, &#39;Bus&#39;, &#39;Oth&#39;]):    </span>
<span class="c1">#     axs[idx].plot(dates[1:n_years*12+1],Y_bottom[idx,:n_years*12], label=&#39;y&#39;)</span>
<span class="c1">#     axs[idx].axhline(y=S_bottom[idx,0],</span>
<span class="c1">#                 label=&#39;level&#39;, color=&#39;black&#39;)</span>
<span class="c1">#     axs[idx].axhline(y=S_bottom[idx,0]*S_bottom[idx,2], </span>
<span class="c1">#                 label=&#39;level_[december]&#39;, color=&#39;green&#39;)</span>
<span class="c1">#     axs[idx].axhline(y=S_bottom[idx,0]*S_bottom[idx,3],</span>
<span class="c1">#                 label=&#39;level_[january]&#39;, color=&#39;red&#39;)</span>
    
<span class="c1">#     axs[idx].plot(dates[1:n_years*12+1],</span>
<span class="c1">#                   F_bottom[idx,0,:n_years*12]*S_bottom[idx,0]*S_bottom[idx,2],</span>
<span class="c1">#                  label=&#39;dummy_[december]&#39;)</span>
<span class="c1">#     axs[idx].plot(dates[1:n_years*12+1],</span>
<span class="c1">#                   F_bottom[idx,1,:n_years*12]*S_bottom[idx,0]*S_bottom[idx,3],</span>
<span class="c1">#                  label=&#39;dummy_[january]&#39;)</span>
<span class="c1">#     axs[idx].set_ylabel(purpose)</span>

<span class="c1"># plt.suptitle(&#39;Y/S/X/F_bottom alignment &#39;, y=0.91)</span>
<span class="c1"># plt.legend(bbox_to_anchor=(1, 1), loc=&#39;upper left&#39;, ncol=1)</span>
<span class="c1"># plt.show()</span>
<span class="c1"># plt.close()</span>

<span class="c1"># #---------------- Y/X_bottom Seq2Seq structure ----------------#</span>
<span class="c1"># idx = 0</span>
<span class="c1"># start = 155</span>
<span class="c1"># end = 203</span>
<span class="c1"># print(&#39;\n&#39;)</span>
<span class="c1"># plt.figure(figsize=(12, 1.8))</span>
<span class="c1"># plt.plot(dates[start:end],     Y_bottom[idx,start:end]+100, label=&#39;y&#39;)</span>
<span class="c1"># plt.plot(dates[start-1:end-1], X_bottom[idx,0,start:end], label=&#39;y_[lag1]&#39;)</span>
<span class="c1"># plt.plot(dates[start:end+12],  F_bottom[idx,2,start:end+12], label=&#39;y_[lag12]&#39;)</span>
<span class="c1"># plt.plot(dates[start:end],     sample_mask[idx,start:end]*Y_bottom[idx,-1], label=&#39;sample_mask&#39;)</span>
<span class="c1"># plt.ylabel(&#39;Tourist Visits\n [In millions]&#39;)</span>
<span class="c1"># plt.title(&#39;Y/X_bottom (Seq2Seq)&#39;)</span>
<span class="c1"># plt.legend(bbox_to_anchor=(1, 1), loc=&#39;upper left&#39;, ncol=1)</span>
<span class="c1"># plt.show()</span>
<span class="c1"># plt.close()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

</div>
 

