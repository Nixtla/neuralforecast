---

title: TimeSeries Dataset


keywords: fastai
sidebar: home_sidebar



nb_path: "nbs/data__tsdataset.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/data__tsdataset.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Base-Dataset">Base Dataset<a class="anchor-link" href="#Base-Dataset"> </a></h2><blockquote><p>Transforms pandas DataFrame into a TimeSeriesDataset for the Dataloder.</p>
</blockquote>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="BaseDataset" class="doc_header"><code>class</code> <code>BaseDataset</code><a href="https://github.com/Nixtla/neuralforecast/tree/main/neuralforecast/data/tsdataset.py#L17" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>BaseDataset</code>(<strong>*<code>args</code></strong>, <strong>**<code>kwds</code></strong>) :: <code>Dataset</code></p>
</blockquote>
<p>A class used to store Time Series data.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="BaseDataset.__getitem__" class="doc_header"><code>BaseDataset.__getitem__</code><a href="https://github.com/Nixtla/neuralforecast/tree/main/neuralforecast/data/tsdataset.py#L277" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>BaseDataset.__getitem__</code>(<strong><code>idx</code></strong>:<code>Union</code>[<code>slice</code>, <code>int</code>])</p>
</blockquote>
<p>Creates batch based on index.</p>
<h2 id="Parameters">Parameters<a class="anchor-link" href="#Parameters"> </a></h2><p>index: np.ndarray
    Indexes of time series to consider.</p>
<h2 id="Returns">Returns<a class="anchor-link" href="#Returns"> </a></h2><p>Dictionary with keys:</p>

<pre><code>- S
- Y
- X
- available_mask
- sample_mask
- idxs</code></pre>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="BaseDataset.__len__" class="doc_header"><code>BaseDataset.__len__</code><a href="https://github.com/Nixtla/neuralforecast/tree/main/neuralforecast/data/tsdataset.py#L301" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>BaseDataset.__len__</code>()</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="BaseDataset.get_n_variables" class="doc_header"><code>BaseDataset.get_n_variables</code><a href="https://github.com/Nixtla/neuralforecast/tree/main/neuralforecast/data/tsdataset.py#L306" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>BaseDataset.get_n_variables</code>()</p>
</blockquote>
<p>Gets number of exogenous and static variables.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="BaseDataset.get_n_series" class="doc_header"><code>BaseDataset.get_n_series</code><a href="https://github.com/Nixtla/neuralforecast/tree/main/neuralforecast/data/tsdataset.py#L311" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>BaseDataset.get_n_series</code>()</p>
</blockquote>
<p>Gets number of time series.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="BaseDataset.get_max_len" class="doc_header"><code>BaseDataset.get_max_len</code><a href="https://github.com/Nixtla/neuralforecast/tree/main/neuralforecast/data/tsdataset.py#L316" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>BaseDataset.get_max_len</code>()</p>
</blockquote>
<p>Gets max len of time series.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="BaseDataset.get_n_channels" class="doc_header"><code>BaseDataset.get_n_channels</code><a href="https://github.com/Nixtla/neuralforecast/tree/main/neuralforecast/data/tsdataset.py#L321" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>BaseDataset.get_n_channels</code>()</p>
</blockquote>
<p>Gets number of channels considered.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="BaseDataset.get_frequency" class="doc_header"><code>BaseDataset.get_frequency</code><a href="https://github.com/Nixtla/neuralforecast/tree/main/neuralforecast/data/tsdataset.py#L326" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>BaseDataset.get_frequency</code>()</p>
</blockquote>
<p>Gets infered frequency.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="get_default_mask_df" class="doc_header"><code>get_default_mask_df</code><a href="https://github.com/Nixtla/neuralforecast/tree/main/neuralforecast/data/tsdataset.py#L332" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>get_default_mask_df</code>(<strong><code>Y_df</code></strong>:<code>DataFrame</code>, <strong><code>ds_in_test</code></strong>:<code>int</code>, <strong><code>is_test</code></strong>:<code>bool</code>)</p>
</blockquote>
<p>Constructs default mask df.</p>
<h2 id="Parameters">Parameters<a class="anchor-link" href="#Parameters"> </a></h2><p>Y_df: pd.DataFrame
    Target time series with columns ['unique_id', 'ds', 'y'].
ds_in_test: int
    Numer of datestamps to use as outsample.
is_test: bool
    Wheter target time series belongs to test set.</p>
<h2 id="Returns">Returns<a class="anchor-link" href="#Returns"> </a></h2><p>Mask DataFrame with columns
['unique_id', 'ds', 'available_mask', 'sample_mask'].</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="TimeSeriesDataset" class="doc_header"><code>class</code> <code>TimeSeriesDataset</code><a href="https://github.com/Nixtla/neuralforecast/tree/main/neuralforecast/data/tsdataset.py#L371" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>TimeSeriesDataset</code>(<strong>*<code>args</code></strong>, <strong>**<code>kwds</code></strong>) :: <a href="/neuralforecast/data__tsdataset.html#BaseDataset"><code>BaseDataset</code></a></p>
</blockquote>
<p>A class used to store Time Series data.
Each element is a windows index.
Returns a windows for all time series.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="TimeSeriesDataset.__getitem__" class="doc_header"><code>TimeSeriesDataset.__getitem__</code><a href="https://github.com/Nixtla/neuralforecast/tree/main/neuralforecast/data/tsdataset.py#L427" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>TimeSeriesDataset.__getitem__</code>(<strong><code>idx</code></strong>:<code>Union</code>[<code>slice</code>, <code>int</code>])</p>
</blockquote>
<p>Creates batch based on index.</p>
<h2 id="Parameters">Parameters<a class="anchor-link" href="#Parameters"> </a></h2><p>index: np.ndarray
    Indexes of time series to consider.</p>
<h2 id="Returns">Returns<a class="anchor-link" href="#Returns"> </a></h2><p>Dictionary with keys:</p>

<pre><code>- S
- Y
- X
- available_mask
- sample_mask
- idxs</code></pre>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="IterateWindows-Dataset">IterateWindows Dataset<a class="anchor-link" href="#IterateWindows-Dataset"> </a></h1>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="IterateWindowsDataset" class="doc_header"><code>class</code> <code>IterateWindowsDataset</code><a href="https://github.com/Nixtla/neuralforecast/tree/main/neuralforecast/data/tsdataset.py#L472" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>IterateWindowsDataset</code>(<strong>*<code>args</code></strong>, <strong>**<code>kwds</code></strong>) :: <a href="/neuralforecast/data__tsdataset.html#BaseDataset"><code>BaseDataset</code></a></p>
</blockquote>
<p>A class used to store Time Series data.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="IterateWindowsDataset.__getitem__" class="doc_header"><code>IterateWindowsDataset.__getitem__</code><a href="https://github.com/Nixtla/neuralforecast/tree/main/neuralforecast/data/tsdataset.py#L531" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>IterateWindowsDataset.__getitem__</code>(<strong><code>idx</code></strong>:<code>int</code>)</p>
</blockquote>
<p>Creates batch based on index.</p>
<h2 id="Parameters">Parameters<a class="anchor-link" href="#Parameters"> </a></h2><p>idx:
    Index of windowß to consider.</p>
<h2 id="Returns">Returns<a class="anchor-link" href="#Returns"> </a></h2><p>Dictionary with keys:</p>

<pre><code>- S
- Y
- X
- available_mask
- sample_mask
- idxs</code></pre>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="IterateWindowsDataset.__len__" class="doc_header"><code>IterateWindowsDataset.__len__</code><a href="https://github.com/Nixtla/neuralforecast/tree/main/neuralforecast/data/tsdataset.py#L577" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>IterateWindowsDataset.__len__</code>()</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Windows-Dataset">Windows Dataset<a class="anchor-link" href="#Windows-Dataset"> </a></h1>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="WindowsDataset" class="doc_header"><code>class</code> <code>WindowsDataset</code><a href="https://github.com/Nixtla/neuralforecast/tree/main/neuralforecast/data/tsdataset.py#L585" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>WindowsDataset</code>(<strong>*<code>args</code></strong>, <strong>**<code>kwds</code></strong>) :: <a href="/neuralforecast/data__tsdataset.html#BaseDataset"><code>BaseDataset</code></a></p>
</blockquote>
<p>A class used to store Time Series data.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="WindowsDataset.__getitem__" class="doc_header"><code>WindowsDataset.__getitem__</code><a href="https://github.com/Nixtla/neuralforecast/tree/main/neuralforecast/data/tsdataset.py#L764" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>WindowsDataset.__getitem__</code>(<strong><code>idx</code></strong>:<code>Union</code>[<code>slice</code>, <code>int</code>])</p>
</blockquote>
<p>Creates batch based on index.</p>
<h2 id="Parameters">Parameters<a class="anchor-link" href="#Parameters"> </a></h2><p>index: np.ndarray
    Indexes of time series to consider.</p>
<h2 id="Returns">Returns<a class="anchor-link" href="#Returns"> </a></h2><p>Dictionary with keys:</p>

<pre><code>- S
- Y
- X
- available_mask
- sample_mask
- idxs</code></pre>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Default-mask-example-and-tests">Default mask example and tests<a class="anchor-link" href="#Default-mask-example-and-tests"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">test_default_mask</span><span class="p">(</span><span class="n">Y_df</span><span class="p">,</span> <span class="n">ds_in_test</span><span class="p">,</span> <span class="n">is_test</span><span class="p">):</span>
    <span class="n">mask_df</span> <span class="o">=</span> <span class="n">get_default_mask_df</span><span class="p">(</span><span class="n">Y_df</span><span class="p">,</span> <span class="n">ds_in_test</span><span class="p">,</span> <span class="n">is_test</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">Y_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">equals</span><span class="p">(</span><span class="n">mask_df</span><span class="o">.</span><span class="n">index</span><span class="p">),</span> <span class="s1">&#39;Unmatching index bewteen Y_df and mask_df&#39;</span>
    
    <span class="k">for</span> <span class="n">uid</span><span class="p">,</span> <span class="n">df</span> <span class="ow">in</span> <span class="n">mask_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;unique_id&#39;</span><span class="p">):</span>
        <span class="n">len_ts</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">expected_sample_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">len_ts</span><span class="p">)</span>
        <span class="n">expected_sample_mask</span><span class="p">[</span><span class="o">-</span><span class="n">ds_in_test</span><span class="p">:]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">is_test</span><span class="p">:</span> 
            <span class="n">expected_sample_mask</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">expected_sample_mask</span>
        <span class="n">expected_available_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">len_ts</span><span class="p">)</span>
        
        <span class="n">sample_mask</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;sample_mask&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">available_mask</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;available_mask&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        
        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">sample_mask</span><span class="p">,</span> <span class="n">expected_sample_mask</span><span class="p">),</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;Error for sample mask for time series </span><span class="si">{</span><span class="n">uid</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="p">)</span>
        
        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">available_mask</span><span class="p">,</span> <span class="n">expected_available_mask</span><span class="p">),</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;Error for available mask for time series </span><span class="si">{</span><span class="n">uid</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Test-for-synthtetic-time-series-data">Test for synthtetic time series data<a class="anchor-link" href="#Test-for-synthtetic-time-series-data"> </a></h3>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">neuralforecast.data.utils</span> <span class="kn">import</span> <span class="n">create_synthetic_tsdata</span>

<span class="n">Y_df</span><span class="p">,</span> <span class="n">X_df</span><span class="p">,</span> <span class="n">S_df</span> <span class="o">=</span> <span class="n">create_synthetic_tsdata</span><span class="p">()</span>
<span class="n">ds_in_test</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">is_test</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">test_default_mask</span><span class="p">(</span><span class="n">Y_df</span><span class="p">,</span> <span class="n">ds_in_test</span><span class="p">,</span> <span class="n">is_test</span><span class="p">)</span>
<span class="n">test_default_mask</span><span class="p">(</span><span class="n">Y_df</span><span class="p">,</span> <span class="n">ds_in_test</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Example-and-test-for-datasets-with-two-time-series">Example and test for datasets with two time series<a class="anchor-link" href="#Example-and-test-for-datasets-with-two-time-series"> </a></h3>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="kn">from</span> <span class="nn">neuralforecast.data.datasets.epf</span> <span class="kn">import</span> <span class="n">EPF</span><span class="p">,</span> <span class="n">EPFInfo</span>

<span class="n">Y_df</span><span class="p">,</span> <span class="n">X_df</span><span class="p">,</span> <span class="n">S_df</span> <span class="o">=</span> <span class="n">EPF</span><span class="o">.</span><span class="n">load_groups</span><span class="p">(</span><span class="n">directory</span><span class="o">=</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="n">groups</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;NP&#39;</span><span class="p">,</span> <span class="s1">&#39;PJM&#39;</span><span class="p">])</span>
<span class="n">test_default_mask</span><span class="p">(</span><span class="n">Y_df</span><span class="p">,</span> <span class="n">ds_in_test</span><span class="o">=</span><span class="mi">728</span> <span class="o">*</span> <span class="mi">24</span><span class="p">,</span> <span class="n">is_test</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">mask_df</span> <span class="o">=</span> <span class="n">get_default_mask_df</span><span class="p">(</span><span class="n">Y_df</span><span class="o">=</span><span class="n">Y_df</span><span class="p">,</span> <span class="n">ds_in_test</span><span class="o">=</span><span class="mi">728</span> <span class="o">*</span> <span class="mi">24</span><span class="p">,</span> <span class="n">is_test</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">mask_df</span><span class="o">.</span><span class="n">sample_mask</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">mask_df</span> <span class="o">=</span> <span class="n">get_default_mask_df</span><span class="p">(</span><span class="n">Y_df</span><span class="o">=</span><span class="n">Y_df</span><span class="p">,</span> <span class="n">ds_in_test</span><span class="o">=</span><span class="mi">728</span> <span class="o">*</span> <span class="mi">24</span><span class="p">,</span> <span class="n">is_test</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">mask_df</span><span class="o">.</span><span class="n">sample_mask</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Test-for-datasets-with-more-than-two-time-series">Test for datasets with more than two time series<a class="anchor-link" href="#Test-for-datasets-with-more-than-two-time-series"> </a></h3>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">neuralforecast.data.datasets.tourism</span> <span class="kn">import</span> <span class="n">Tourism</span><span class="p">,</span> <span class="n">TourismInfo</span>

<span class="n">meta</span> <span class="o">=</span> <span class="n">TourismInfo</span><span class="p">[</span><span class="s1">&#39;Yearly&#39;</span><span class="p">]</span>
<span class="n">Y_df</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="o">=</span> <span class="n">Tourism</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">directory</span><span class="o">=</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="n">meta</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="n">test_default_mask</span><span class="p">(</span><span class="n">Y_df</span><span class="p">,</span> <span class="n">ds_in_test</span><span class="o">=</span><span class="n">meta</span><span class="o">.</span><span class="n">horizon</span><span class="p">,</span> <span class="n">is_test</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">test_default_mask</span><span class="p">(</span><span class="n">Y_df</span><span class="p">,</span> <span class="n">ds_in_test</span><span class="o">=</span><span class="n">meta</span><span class="o">.</span><span class="n">horizon</span><span class="p">,</span> <span class="n">is_test</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Dataset-tests">Dataset tests<a class="anchor-link" href="#Dataset-tests"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">instantiate_datasets</span><span class="p">(</span><span class="n">Y_df</span><span class="p">,</span> <span class="n">S_df</span><span class="p">,</span> <span class="n">X_df</span><span class="p">,</span> <span class="n">f_cols</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
                         <span class="n">ds_in_test</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">is_test</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                         <span class="n">input_size</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span>
                         <span class="n">output_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                         <span class="n">complete_windows</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                         <span class="n">sample_freq</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">mask_df</span> <span class="o">=</span> <span class="n">get_default_mask_df</span><span class="p">(</span><span class="n">Y_df</span><span class="o">=</span><span class="n">Y_df</span><span class="p">,</span> <span class="n">ds_in_test</span><span class="o">=</span><span class="n">ds_in_test</span><span class="p">,</span> <span class="n">is_test</span><span class="o">=</span><span class="n">is_test</span><span class="p">)</span>
                        
    <span class="n">ts_dataset</span> <span class="o">=</span> <span class="n">TimeSeriesDataset</span><span class="p">(</span><span class="n">Y_df</span><span class="o">=</span><span class="n">Y_df</span><span class="p">,</span> <span class="n">S_df</span><span class="o">=</span><span class="n">S_df</span><span class="p">,</span> <span class="n">X_df</span><span class="o">=</span><span class="n">X_df</span><span class="p">,</span> <span class="n">f_cols</span><span class="o">=</span><span class="n">f_cols</span><span class="p">,</span> 
                                   <span class="n">mask_df</span><span class="o">=</span><span class="n">mask_df</span><span class="p">,</span>
                                   <span class="n">input_size</span><span class="o">=</span><span class="n">input_size</span><span class="p">,</span>
                                   <span class="n">output_size</span><span class="o">=</span><span class="n">output_size</span><span class="p">,</span>
                                   <span class="n">complete_windows</span><span class="o">=</span><span class="n">complete_windows</span><span class="p">)</span>
    
    <span class="n">wd_dataset</span> <span class="o">=</span> <span class="n">WindowsDataset</span><span class="p">(</span><span class="n">Y_df</span><span class="o">=</span><span class="n">Y_df</span><span class="p">,</span> <span class="n">S_df</span><span class="o">=</span><span class="n">S_df</span><span class="p">,</span> <span class="n">X_df</span><span class="o">=</span><span class="n">X_df</span><span class="p">,</span> <span class="n">f_cols</span><span class="o">=</span><span class="n">f_cols</span><span class="p">,</span> 
                                   <span class="n">mask_df</span><span class="o">=</span><span class="n">mask_df</span><span class="p">,</span>
                                   <span class="n">input_size</span><span class="o">=</span><span class="n">input_size</span><span class="p">,</span>
                                   <span class="n">output_size</span><span class="o">=</span><span class="n">output_size</span><span class="p">,</span>
                                   <span class="n">sample_freq</span><span class="o">=</span><span class="n">sample_freq</span><span class="p">,</span>
                                   <span class="n">complete_windows</span><span class="o">=</span><span class="n">complete_windows</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">ts_dataset</span><span class="p">,</span> <span class="n">wd_dataset</span><span class="p">,</span> <span class="n">mask_df</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">test_dataset_attrs</span><span class="p">(</span><span class="n">Y_df</span><span class="p">,</span> <span class="n">S_df</span><span class="p">,</span> <span class="n">X_df</span><span class="p">,</span> <span class="n">f_cols</span><span class="p">,</span> <span class="n">ds_in_test</span><span class="p">,</span> <span class="n">is_test</span><span class="p">):</span>
    <span class="c1"># This set catches mistmaches between Y_df and ts_tensor</span>
    <span class="n">ts_dataset</span><span class="p">,</span> <span class="n">wd_dataset</span><span class="p">,</span> <span class="n">mask_df</span> <span class="o">=</span> <span class="n">instantiate_datasets</span><span class="p">(</span><span class="n">Y_df</span><span class="o">=</span><span class="n">Y_df</span><span class="p">,</span> <span class="n">S_df</span><span class="o">=</span><span class="n">S_df</span><span class="p">,</span> <span class="n">X_df</span><span class="o">=</span><span class="n">X_df</span><span class="p">,</span> 
                                           <span class="n">f_cols</span><span class="o">=</span><span class="n">f_cols</span><span class="p">,</span> <span class="n">ds_in_test</span><span class="o">=</span><span class="n">ds_in_test</span><span class="p">,</span> 
                                           <span class="n">is_test</span><span class="o">=</span><span class="n">is_test</span><span class="p">)</span>
    
    <span class="n">dfs</span> <span class="o">=</span> <span class="p">[</span><span class="n">Y_df</span><span class="p">,</span> <span class="n">X_df</span><span class="p">,</span> <span class="n">mask_df</span><span class="p">]</span>
    <span class="n">dfs</span> <span class="o">=</span> <span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s1">&#39;unique_id&#39;</span><span class="p">,</span> <span class="s1">&#39;ds&#39;</span><span class="p">])</span> <span class="k">for</span> <span class="n">df</span> <span class="ow">in</span> <span class="n">dfs</span><span class="p">]</span>
    <span class="n">dfs</span> <span class="o">=</span> <span class="n">dfs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dfs</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
    
    <span class="c1">#Temporal variables</span>
    <span class="k">for</span> <span class="n">dataset</span> <span class="ow">in</span> <span class="p">[</span><span class="n">ts_dataset</span><span class="p">,</span> <span class="n">wd_dataset</span><span class="p">]:</span>
        <span class="k">for</span> <span class="n">idx_ts</span><span class="p">,</span> <span class="p">(</span><span class="n">uid</span><span class="p">,</span> <span class="n">df</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dfs</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;unique_id&#39;</span><span class="p">)):</span>
            <span class="n">len_ts</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">len_series</span><span class="p">[</span><span class="n">idx_ts</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">dataset</span><span class="o">.</span><span class="n">t_cols</span><span class="p">:</span>
                <span class="n">ts</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
                <span class="n">idx_tensor</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">t_cols</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
                <span class="n">ts_tensor</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">ts_tensor</span><span class="p">[</span><span class="n">idx_ts</span><span class="p">,</span> <span class="n">idx_tensor</span><span class="p">,</span> <span class="o">-</span><span class="n">len_ts</span><span class="p">:]</span>

                <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">ts_tensor</span><span class="p">),</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;Error with time series </span><span class="si">{</span><span class="n">uid</span><span class="si">}</span><span class="s1"> and col </span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s1"> (idx=</span><span class="si">{</span><span class="n">idx_ts</span><span class="si">}</span><span class="s1">).&#39;</span>
                <span class="p">)</span>

        <span class="c1">#Static variables</span>
        <span class="k">for</span> <span class="n">idx_ts</span><span class="p">,</span> <span class="p">(</span><span class="n">uid</span><span class="p">,</span> <span class="n">df</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">S_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;unique_id&#39;</span><span class="p">)):</span>
            <span class="n">len_ts</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">len_series</span><span class="p">[</span><span class="n">idx_ts</span><span class="p">]</span>

            <span class="n">s</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">dataset</span><span class="o">.</span><span class="n">s_cols</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
            <span class="n">s_matrix</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">s_matrix</span><span class="p">[[</span><span class="n">idx_ts</span><span class="p">]]</span>

            <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">s_matrix</span><span class="p">),</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;Error with static variables for time series </span><span class="si">{</span><span class="n">uid</span><span class="si">}</span><span class="s1"> (idx=</span><span class="si">{</span><span class="n">idx_ts</span><span class="si">}</span><span class="s1">)&#39;</span>
            <span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">test_get_f_idxs</span><span class="p">(</span><span class="n">Y_df</span><span class="p">,</span> <span class="n">S_df</span><span class="p">,</span> <span class="n">X_df</span><span class="p">,</span> <span class="n">f_cols</span><span class="p">,</span> <span class="n">ds_in_test</span><span class="p">,</span> <span class="n">is_test</span><span class="p">,</span> <span class="n">expected_f_idxs</span><span class="p">):</span>
    <span class="n">ts_dataset</span><span class="p">,</span> <span class="n">wd_dataset</span><span class="p">,</span> <span class="n">mask_df</span> <span class="o">=</span> <span class="n">instantiate_datasets</span><span class="p">(</span><span class="n">Y_df</span><span class="o">=</span><span class="n">Y_df</span><span class="p">,</span> <span class="n">S_df</span><span class="o">=</span><span class="n">S_df</span><span class="p">,</span> <span class="n">X_df</span><span class="o">=</span><span class="n">X_df</span><span class="p">,</span> 
                                           <span class="n">f_cols</span><span class="o">=</span><span class="n">f_cols</span><span class="p">,</span> <span class="n">ds_in_test</span><span class="o">=</span><span class="n">ds_in_test</span><span class="p">,</span> 
                                           <span class="n">is_test</span><span class="o">=</span><span class="n">is_test</span><span class="p">)</span>
    
    <span class="k">assert</span> <span class="n">ts_dataset</span><span class="o">.</span><span class="n">_get_f_idxs</span><span class="p">(</span><span class="n">f_cols</span><span class="p">)</span> <span class="o">==</span> <span class="n">expected_f_idxs</span>
    <span class="k">assert</span> <span class="n">wd_dataset</span><span class="o">.</span><span class="n">_get_f_idxs</span><span class="p">(</span><span class="n">f_cols</span><span class="p">)</span> <span class="o">==</span> <span class="n">expected_f_idxs</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">test_ts_tensor</span><span class="p">(</span><span class="n">Y_df</span><span class="p">,</span> <span class="n">S_df</span><span class="p">,</span> <span class="n">X_df</span><span class="p">,</span> <span class="n">f_cols</span><span class="p">,</span> <span class="n">ds_in_test</span><span class="p">,</span> <span class="n">is_test</span><span class="p">,</span> 
                   <span class="n">input_size</span><span class="p">,</span> <span class="n">output_size</span><span class="p">,</span> <span class="n">ts_idxs</span><span class="p">):</span>
    <span class="n">ts_dataset</span><span class="p">,</span> <span class="n">wd_dataset</span><span class="p">,</span> <span class="n">mask_df</span> <span class="o">=</span> <span class="n">instantiate_datasets</span><span class="p">(</span><span class="n">Y_df</span><span class="o">=</span><span class="n">Y_df</span><span class="p">,</span> <span class="n">S_df</span><span class="o">=</span><span class="n">S_df</span><span class="p">,</span> <span class="n">X_df</span><span class="o">=</span><span class="n">X_df</span><span class="p">,</span> 
                                           <span class="n">f_cols</span><span class="o">=</span><span class="n">f_cols</span><span class="p">,</span> <span class="n">ds_in_test</span><span class="o">=</span><span class="n">ds_in_test</span><span class="p">,</span> 
                                           <span class="n">is_test</span><span class="o">=</span><span class="n">is_test</span><span class="p">,</span>
                                           <span class="n">input_size</span><span class="o">=</span><span class="n">input_size</span><span class="p">,</span>
                                           <span class="n">output_size</span><span class="o">=</span><span class="n">output_size</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">dataset</span> <span class="ow">in</span> <span class="p">[</span><span class="n">ts_dataset</span><span class="p">,</span> <span class="n">wd_dataset</span><span class="p">]:</span>
        <span class="n">min_len</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">len_series</span><span class="p">)</span>
        <span class="n">dfs</span> <span class="o">=</span> <span class="p">[</span><span class="n">Y_df</span><span class="p">,</span> <span class="n">X_df</span><span class="p">,</span> <span class="n">mask_df</span><span class="p">]</span>
        <span class="n">dfs</span> <span class="o">=</span> <span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s1">&#39;unique_id&#39;</span><span class="p">,</span> <span class="s1">&#39;ds&#39;</span><span class="p">])</span> <span class="k">for</span> <span class="n">df</span> <span class="ow">in</span> <span class="n">dfs</span><span class="p">]</span>
        <span class="n">dfs</span> <span class="o">=</span> <span class="n">dfs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dfs</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
        
        <span class="c1"># This process only works for balanced datasets.</span>
        
        <span class="n">n_ts</span> <span class="o">=</span> <span class="n">Y_df</span><span class="p">[</span><span class="s1">&#39;unique_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">n_x</span> <span class="o">=</span> <span class="n">dfs</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">idxs</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_ts</span><span class="p">)</span> <span class="k">if</span> <span class="n">ts_idxs</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">ts_idxs</span>

        <span class="n">e_filtered_tensor</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">dfs</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">n_ts</span><span class="p">,</span> <span class="n">min_len</span><span class="p">,</span> <span class="n">n_x</span><span class="p">))[</span><span class="n">idxs</span><span class="p">])</span>
        <span class="n">e_filtered_tensor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="n">e_filtered_tensor</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">filtered_tensor</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">ts_tensor</span><span class="p">[</span><span class="n">ts_idxs</span><span class="p">,</span> <span class="p">:,</span> <span class="n">dataset</span><span class="o">.</span><span class="n">first_ds</span><span class="p">:]</span>

        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">e_filtered_tensor</span><span class="p">,</span> <span class="n">filtered_tensor</span><span class="p">),</span> <span class="p">(</span>
            <span class="s2">&quot;Expected and dataset filtered_tensor are different. Check.&quot;</span>
        <span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">numpy.lib.stride_tricks</span> <span class="kn">import</span> <span class="n">sliding_window_view</span>

<span class="c1"># This test only works for the synthetic dataset constructed </span>
<span class="c1"># using create_synthetic_tsdata</span>
<span class="c1"># and for the 21 time series</span>
<span class="k">def</span> <span class="nf">test_batch_construction_windows</span><span class="p">(</span><span class="n">Y_df</span><span class="p">,</span> <span class="n">S_df</span><span class="p">,</span> <span class="n">X_df</span><span class="p">,</span> <span class="n">ds_in_test</span><span class="p">,</span> 
                                    <span class="n">is_test</span><span class="p">,</span> <span class="n">input_size</span><span class="p">,</span> <span class="n">output_size</span><span class="p">,</span> <span class="n">sample_freq</span><span class="p">,</span> 
                                    <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Test to verify that the batch (of windows) is well constructed.&quot;&quot;&quot;</span>

    <span class="n">_</span><span class="p">,</span> <span class="n">dataset</span><span class="p">,</span> <span class="n">mask_df</span> <span class="o">=</span> <span class="n">instantiate_datasets</span><span class="p">(</span><span class="n">Y_df</span><span class="o">=</span><span class="n">Y_df</span><span class="p">,</span> <span class="n">S_df</span><span class="o">=</span><span class="n">S_df</span><span class="p">,</span> <span class="n">X_df</span><span class="o">=</span><span class="n">X_df</span><span class="p">,</span> 
                                               <span class="n">ds_in_test</span><span class="o">=</span><span class="n">ds_in_test</span><span class="p">,</span> <span class="n">is_test</span><span class="o">=</span><span class="n">is_test</span><span class="p">,</span>
                                               <span class="n">input_size</span><span class="o">=</span><span class="n">input_size</span><span class="p">,</span>
                                               <span class="n">output_size</span><span class="o">=</span><span class="n">output_size</span><span class="p">,</span>
                                               <span class="n">sample_freq</span><span class="o">=</span><span class="n">sample_freq</span><span class="p">)</span>
    
    <span class="n">windows_size</span> <span class="o">=</span> <span class="n">input_size</span> <span class="o">+</span> <span class="n">output_size</span>
    <span class="n">max_len</span> <span class="o">=</span> <span class="n">Y_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;unique_id&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">size</span><span class="p">()</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    
    <span class="n">windows</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">[</span><span class="mi">20</span><span class="p">][</span><span class="s1">&#39;Y&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
    
    <span class="c1">#Expected windows</span>
    <span class="n">uid</span> <span class="o">=</span> <span class="n">Y_df</span><span class="p">[</span><span class="s1">&#39;unique_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()[</span><span class="mi">20</span><span class="p">]</span>
    <span class="n">Y_original</span> <span class="o">=</span> <span class="n">Y_df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;unique_id == @uid&#39;</span><span class="p">)[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="n">size</span> <span class="o">=</span> <span class="n">Y_original</span><span class="o">.</span><span class="n">size</span>
    <span class="n">Y_sample</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">max_len</span><span class="p">)</span>
    <span class="n">Y_sample</span><span class="p">[</span><span class="o">-</span><span class="n">size</span><span class="p">:]</span> <span class="o">=</span> <span class="n">Y_original</span>
    
    <span class="n">Y_sample</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">Y_sample</span><span class="p">,</span> <span class="p">(</span><span class="n">input_size</span><span class="o">+</span><span class="mi">100</span><span class="p">,</span> <span class="n">output_size</span><span class="p">))</span>

    <span class="n">e_windows</span> <span class="o">=</span> <span class="n">sliding_window_view</span><span class="p">(</span><span class="n">Y_sample</span><span class="p">,</span> <span class="n">window_shape</span><span class="o">=</span><span class="n">windows_size</span><span class="p">)</span>
    <span class="n">e_windows</span> <span class="o">=</span> <span class="n">e_windows</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="p">(</span><span class="n">ds_in_test</span><span class="o">+</span><span class="n">output_size</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span><span class="n">sample_freq</span><span class="p">]</span> <span class="c1">#-1 for at least one available sample</span>

    <span class="c1"># This test works assuming there are no series with all values of zero.</span>
    <span class="n">sampleable_windows_idxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">e_windows</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>     
    <span class="n">e_windows</span> <span class="o">=</span> <span class="n">e_windows</span><span class="p">[</span><span class="n">sampleable_windows_idxs</span><span class="p">]</span>
    
    <span class="c1">#Comparison</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">windows</span><span class="p">,</span> <span class="n">e_windows</span><span class="p">),</span> <span class="p">(</span>
        <span class="s1">&#39;Expected and actual windows are different&#39;</span>
    <span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">numpy.lib.stride_tricks</span> <span class="kn">import</span> <span class="n">sliding_window_view</span>

<span class="c1"># This test only works for the synthetic dataset constructed </span>
<span class="c1"># using create_synthetic_tsdata</span>
<span class="c1"># and for the 21 time series</span>
<span class="k">def</span> <span class="nf">test_batch_construction_ts</span><span class="p">(</span><span class="n">Y_df</span><span class="p">,</span> <span class="n">S_df</span><span class="p">,</span> <span class="n">X_df</span><span class="p">,</span> <span class="n">ds_in_test</span><span class="p">,</span> 
                                    <span class="n">is_test</span><span class="p">,</span> <span class="n">input_size</span><span class="p">,</span> <span class="n">output_size</span><span class="p">,</span> <span class="n">sample_freq</span><span class="p">,</span> 
                                    <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Test to verify that the batch (of windows) is well constructed.&quot;&quot;&quot;</span>

    <span class="n">dataset</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">mask_df</span> <span class="o">=</span> <span class="n">instantiate_datasets</span><span class="p">(</span><span class="n">Y_df</span><span class="o">=</span><span class="n">Y_df</span><span class="p">,</span> <span class="n">S_df</span><span class="o">=</span><span class="n">S_df</span><span class="p">,</span> <span class="n">X_df</span><span class="o">=</span><span class="n">X_df</span><span class="p">,</span> 
                                               <span class="n">ds_in_test</span><span class="o">=</span><span class="n">ds_in_test</span><span class="p">,</span> <span class="n">is_test</span><span class="o">=</span><span class="n">is_test</span><span class="p">,</span>
                                               <span class="n">input_size</span><span class="o">=</span><span class="n">input_size</span><span class="p">,</span>
                                               <span class="n">output_size</span><span class="o">=</span><span class="n">output_size</span><span class="p">,</span>
                                               <span class="n">sample_freq</span><span class="o">=</span><span class="n">sample_freq</span><span class="p">)</span>
    
    <span class="n">batch</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">[</span><span class="mi">20</span><span class="p">][</span><span class="s1">&#39;Y&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
    <span class="n">max_len</span> <span class="o">=</span> <span class="n">Y_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;unique_id&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">size</span><span class="p">()</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    
    <span class="c1">#Expected windows</span>
    <span class="n">uid</span> <span class="o">=</span> <span class="n">Y_df</span><span class="p">[</span><span class="s1">&#39;unique_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()[</span><span class="mi">20</span><span class="p">]</span>
    <span class="n">Y_original</span> <span class="o">=</span> <span class="n">Y_df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;unique_id == @uid&#39;</span><span class="p">)[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="n">size</span> <span class="o">=</span> <span class="n">Y_original</span><span class="o">.</span><span class="n">size</span>
    <span class="n">e_batch</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">max_len</span><span class="p">)</span>
    <span class="n">e_batch</span><span class="p">[</span><span class="o">-</span><span class="n">size</span><span class="p">:]</span> <span class="o">=</span> <span class="n">Y_original</span>
    <span class="n">e_batch</span> <span class="o">=</span> <span class="n">e_batch</span><span class="p">[</span><span class="kc">None</span><span class="p">,:]</span>

    <span class="c1">#Comparison</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">e_batch</span><span class="p">),</span> <span class="p">(</span>
        <span class="s1">&#39;Expected and actual windows are different&#39;</span>
    <span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Test-for-not-sorted-datasets-with-more-than-two-time-series">Test for not sorted datasets with more than two time series<a class="anchor-link" href="#Test-for-not-sorted-datasets-with-more-than-two-time-series"> </a></h3>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">neuralforecast.data.utils</span> <span class="kn">import</span> <span class="n">create_synthetic_tsdata</span>

<span class="n">Y_df</span><span class="p">,</span> <span class="n">X_df</span><span class="p">,</span> <span class="n">S_df</span> <span class="o">=</span> <span class="n">create_synthetic_tsdata</span><span class="p">()</span>
<span class="n">ds_in_test</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">is_test</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">f_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;future_1&#39;</span><span class="p">]</span>
<span class="n">expected_f_idxs</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">]</span>
<span class="n">len_sample_chunks</span> <span class="o">=</span> <span class="mi">15</span> <span class="c1">#only for ESRNN</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">test_dataset_attrs</span><span class="p">(</span><span class="n">Y_df</span><span class="p">,</span> <span class="n">S_df</span><span class="p">,</span> <span class="n">X_df</span><span class="p">,</span> <span class="n">f_cols</span><span class="o">=</span><span class="n">f_cols</span><span class="p">,</span> <span class="n">ds_in_test</span><span class="o">=</span><span class="n">ds_in_test</span><span class="p">,</span> <span class="n">is_test</span><span class="o">=</span><span class="n">is_test</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">test_get_f_idxs</span><span class="p">(</span><span class="n">Y_df</span><span class="p">,</span> <span class="n">S_df</span><span class="p">,</span> <span class="n">X_df</span><span class="p">,</span> <span class="n">f_cols</span><span class="o">=</span><span class="n">f_cols</span><span class="p">,</span> <span class="n">ds_in_test</span><span class="o">=</span><span class="n">ds_in_test</span><span class="p">,</span> <span class="n">is_test</span><span class="o">=</span><span class="n">is_test</span><span class="p">,</span> 
                <span class="n">expected_f_idxs</span><span class="o">=</span><span class="n">expected_f_idxs</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Expected-error-for-non-sorted-datasets">Expected error for non-sorted datasets<a class="anchor-link" href="#Expected-error-for-non-sorted-datasets"> </a></h4><p>For the <code>ts_tensor</code> attribute from the <code>dataset</code> and <code>Y_df</code> to have the same order it is necessary that <code>Y_df</code> is sorted by <code>unique_id</code> and <code>ds</code>. This test (expected error) proves that for unordered data the order is different.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">_fail_non_sorted</span><span class="p">():</span> 
    <span class="n">test_ts_tensor</span><span class="p">(</span><span class="n">Y_df</span><span class="p">,</span> <span class="n">S_df</span><span class="p">,</span> <span class="n">X_df</span><span class="p">,</span> <span class="n">f_cols</span><span class="o">=</span><span class="n">f_cols</span><span class="p">,</span> 
                   <span class="n">ds_in_test</span><span class="o">=</span><span class="n">ds_in_test</span><span class="p">,</span> 
                   <span class="n">is_test</span><span class="o">=</span><span class="n">is_test</span><span class="p">,</span>
                   <span class="n">ts_idxs</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> 
                   <span class="n">output_size</span><span class="o">=</span><span class="n">ds_in_test</span><span class="p">)</span>
<span class="n">test_fail</span><span class="p">(</span><span class="n">_fail_non_sorted</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Test-using-sorted-synthtic-ts-data">Test using sorted synthtic ts data<a class="anchor-link" href="#Test-using-sorted-synthtic-ts-data"> </a></h4>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">neuralforecast.data.utils</span> <span class="kn">import</span> <span class="n">create_synthetic_tsdata</span>

<span class="n">Y_df</span><span class="p">,</span> <span class="n">X_df</span><span class="p">,</span> <span class="n">S_df</span> <span class="o">=</span> <span class="n">create_synthetic_tsdata</span><span class="p">(</span><span class="n">sort</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">ds_in_test</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">is_test</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">f_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;future_1&#39;</span><span class="p">]</span>
<span class="n">expected_f_idxs</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">]</span>
<span class="n">len_sample_chunks</span> <span class="o">=</span> <span class="mi">15</span> <span class="c1">#only for ESRNN</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">test_batch_construction_windows</span><span class="p">(</span><span class="n">Y_df</span><span class="p">,</span> <span class="n">S_df</span><span class="p">,</span> <span class="n">X_df</span><span class="p">,</span> <span class="n">ds_in_test</span><span class="o">=</span><span class="n">ds_in_test</span><span class="p">,</span>
                                <span class="n">is_test</span><span class="o">=</span><span class="n">is_test</span><span class="p">,</span> <span class="n">input_size</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">output_size</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                                <span class="n">sample_freq</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">test_batch_construction_ts</span><span class="p">(</span><span class="n">Y_df</span><span class="p">,</span> <span class="n">S_df</span><span class="p">,</span> <span class="n">X_df</span><span class="p">,</span> <span class="n">ds_in_test</span><span class="o">=</span><span class="n">ds_in_test</span><span class="p">,</span>
                           <span class="n">is_test</span><span class="o">=</span><span class="n">is_test</span><span class="p">,</span> <span class="n">input_size</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">output_size</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                           <span class="n">sample_freq</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Test-for-already-sorted-datasets">Test for already sorted datasets<a class="anchor-link" href="#Test-for-already-sorted-datasets"> </a></h3>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">neuralforecast.data.datasets.epf</span> <span class="kn">import</span> <span class="n">EPF</span><span class="p">,</span> <span class="n">EPFInfo</span>

<span class="n">Y_df</span><span class="p">,</span> <span class="n">X_df</span><span class="p">,</span> <span class="n">S_df</span> <span class="o">=</span> <span class="n">EPF</span><span class="o">.</span><span class="n">load_groups</span><span class="p">(</span><span class="n">directory</span><span class="o">=</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="n">groups</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;NP&#39;</span><span class="p">,</span> <span class="s1">&#39;PJM&#39;</span><span class="p">])</span>
<span class="n">f_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Exogenous1&#39;</span><span class="p">,</span> <span class="s1">&#39;Exogenous2&#39;</span><span class="p">]</span>
<span class="n">ds_in_test</span> <span class="o">=</span> <span class="mi">728</span> <span class="o">*</span> <span class="mi">24</span>
<span class="n">is_test</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">expected_f_idxs</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="c1">#after y column</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">test_dataset_attrs</span><span class="p">(</span><span class="n">Y_df</span><span class="p">,</span> <span class="n">S_df</span><span class="p">,</span> <span class="n">X_df</span><span class="p">,</span> <span class="n">f_cols</span><span class="o">=</span><span class="n">f_cols</span><span class="p">,</span> <span class="n">ds_in_test</span><span class="o">=</span><span class="n">ds_in_test</span><span class="p">,</span> <span class="n">is_test</span><span class="o">=</span><span class="n">is_test</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">test_ts_tensor</span><span class="p">(</span><span class="n">Y_df</span><span class="p">,</span> <span class="n">S_df</span><span class="p">,</span> <span class="n">X_df</span><span class="p">,</span> <span class="n">f_cols</span><span class="o">=</span><span class="n">f_cols</span><span class="p">,</span> <span class="n">ds_in_test</span><span class="o">=</span><span class="n">ds_in_test</span><span class="p">,</span> <span class="n">is_test</span><span class="o">=</span><span class="n">is_test</span><span class="p">,</span>
               <span class="n">input_size</span><span class="o">=</span><span class="n">ds_in_test</span><span class="p">,</span> <span class="n">output_size</span><span class="o">=</span><span class="n">ds_in_test</span><span class="p">,</span> <span class="n">ts_idxs</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">test_get_f_idxs</span><span class="p">(</span><span class="n">Y_df</span><span class="p">,</span> <span class="n">S_df</span><span class="p">,</span> <span class="n">X_df</span><span class="p">,</span> <span class="n">f_cols</span><span class="o">=</span><span class="n">f_cols</span><span class="p">,</span> <span class="n">ds_in_test</span><span class="o">=</span><span class="n">ds_in_test</span><span class="p">,</span> <span class="n">is_test</span><span class="o">=</span><span class="n">is_test</span><span class="p">,</span> 
                <span class="n">expected_f_idxs</span><span class="o">=</span><span class="n">expected_f_idxs</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Test-for-already-sorted-datasets-with-more-than-two-time-series">Test for already sorted datasets with more than two time series<a class="anchor-link" href="#Test-for-already-sorted-datasets-with-more-than-two-time-series"> </a></h3>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">neuralforecast.data.datasets.tourism</span> <span class="kn">import</span> <span class="n">Tourism</span><span class="p">,</span> <span class="n">TourismInfo</span>

<span class="n">meta</span> <span class="o">=</span> <span class="n">TourismInfo</span><span class="p">[</span><span class="s1">&#39;Yearly&#39;</span><span class="p">]</span>
<span class="n">df</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="o">=</span> <span class="n">Tourism</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">directory</span><span class="o">=</span><span class="s1">&#39;./data&#39;</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="n">meta</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;day_of_week&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;ds&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">day_of_week</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;id_ts&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;unique_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;category&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">cat</span><span class="o">.</span><span class="n">codes</span>

<span class="n">Y_df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">items</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;unique_id&#39;</span><span class="p">,</span> <span class="s1">&#39;ds&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">])</span>
<span class="n">X_df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">items</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;unique_id&#39;</span><span class="p">,</span> <span class="s1">&#39;ds&#39;</span><span class="p">,</span> <span class="s1">&#39;day_of_week&#39;</span><span class="p">])</span>
<span class="n">S_df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">items</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;unique_id&#39;</span><span class="p">,</span> <span class="s1">&#39;id_ts&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">Y_df</span> <span class="o">=</span> <span class="n">Y_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;unique_id&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">tail</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span>
<span class="n">X_df</span> <span class="o">=</span> <span class="n">X_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;unique_id&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">tail</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">test_dataset_attrs</span><span class="p">(</span><span class="n">Y_df</span><span class="p">,</span> <span class="n">S_df</span><span class="p">,</span> <span class="n">X_df</span><span class="p">,</span> <span class="n">f_cols</span><span class="o">=</span><span class="p">[],</span> <span class="n">ds_in_test</span><span class="o">=</span><span class="n">meta</span><span class="o">.</span><span class="n">horizon</span><span class="p">,</span> <span class="n">is_test</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">test_ts_tensor</span><span class="p">(</span><span class="n">Y_df</span><span class="p">,</span> <span class="n">S_df</span><span class="p">,</span> <span class="n">X_df</span><span class="p">,</span> <span class="n">f_cols</span><span class="o">=</span><span class="p">[],</span> <span class="n">ds_in_test</span><span class="o">=</span><span class="n">meta</span><span class="o">.</span><span class="n">horizon</span><span class="p">,</span> <span class="n">is_test</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
               <span class="n">input_size</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> 
               <span class="n">output_size</span><span class="o">=</span><span class="n">meta</span><span class="o">.</span><span class="n">horizon</span><span class="p">,</span> <span class="n">ts_idxs</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">15</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">test_get_f_idxs</span><span class="p">(</span><span class="n">Y_df</span><span class="p">,</span> <span class="n">S_df</span><span class="p">,</span> <span class="n">X_df</span><span class="p">,</span> <span class="n">f_cols</span><span class="o">=</span><span class="p">[],</span> <span class="n">ds_in_test</span><span class="o">=</span><span class="n">ds_in_test</span><span class="p">,</span> <span class="n">is_test</span><span class="o">=</span><span class="n">is_test</span><span class="p">,</span> 
                <span class="n">expected_f_idxs</span><span class="o">=</span><span class="p">[])</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

</div>
 

