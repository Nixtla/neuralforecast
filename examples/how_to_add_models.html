<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="description" content="Tutorial on how to add new models to NeuralForecast">

<title>neuralforecast - How to add new Models to NeuralForecast</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../favicon_png.png" rel="icon" type="image/png">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-NXJNCVR18L"></script>

<script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-NXJNCVR18L', { 'anonymize_ip': true});
</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="../styles.css">
<meta property="og:title" content="neuralforecast - How to add new Models to NeuralForecast">
<meta property="og:description" content="Tutorial on how to add new models to NeuralForecast">
<meta property="og:image" content="https://github.com/Nixtla/styles/blob/2abf51612584169874c90cd7c4d347e3917eaf73/images/Banner%20Github.png">
<meta property="og:site-name" content="neuralforecast">
<meta name="twitter:title" content="neuralforecast - How to add new Models to NeuralForecast">
<meta name="twitter:description" content="Tutorial on how to add new models to NeuralForecast">
<meta name="twitter:image" content="https://farm6.staticflickr.com/5510/14338202952_93595258ff_z.jpg">
<meta name="twitter:site" content="@Nixtlainc">
<meta name="twitter:card" content="summary_large_image">
</head>

<body class="nav-sidebar floating nav-fixed">


<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">neuralforecast</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link active" href="../examples/getting_started.html" rel="" target="" aria-current="page">
 <span class="menu-text">Get Started</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-nixtlaverse" role="button" data-bs-toggle="dropdown" aria-expanded="false" rel="" target="">
 <span class="menu-text">NixtlaVerse</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-nixtlaverse">    
        <li>
    <a class="dropdown-item" href="https://github.com/nixtla/mlforecast" rel="" target="">
 <span class="dropdown-text">MLForecast ü§ñ</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://github.com/nixtla/statsforecast" rel="" target="">
 <span class="dropdown-text">StatsForecast ‚ö°Ô∏è</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://github.com/nixtla/hierarchicalforecast" rel="" target="">
 <span class="dropdown-text">HierarchicalForecast üëë</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-help" role="button" data-bs-toggle="dropdown" aria-expanded="false" rel="" target="">
 <span class="menu-text">Help</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-help">    
        <li>
    <a class="dropdown-item" href="https://github.com/nixtla/neuralforecast/issues/new/choose" rel="" target=""><i class="bi bi-bug" role="img">
</i> 
 <span class="dropdown-text">Report an Issue</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://join.slack.com/t/nixtlaworkspace/shared_invite/zt-135dssye9-fWTzMpv2WBthq8NK0Yvu6A" rel="" target=""><i class="bi bi-chat-right-text" role="img">
</i> 
 <span class="dropdown-text">Join our Slack</span></a>
  </li>  
    </ul>
  </li>
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/nixtla/neuralforecast" rel="" target=""><i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/nixtlainc" rel="" target=""><i class="bi bi-twitter" role="img" aria-label="Nixtla Twitter">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools">
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
      <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../examples/installation.html">Getting Started</a></li><li class="breadcrumb-item"><a href="../examples/how_to_add_models.html">How to add new Models to NeuralForecast</a></li></ol></nav>
      <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
      </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">üß† NeuralForecast</span></a>
  </div>
</li>
        <li class="px-0"><hr class="sidebar-divider hi "></li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
 <span class="menu-text">Getting Started</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../examples/installation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Install</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../examples/getting_started.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Getting Started</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../examples/data_format.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Data Inputs</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../examples/exogenous_variables.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Exogenous Variables</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../examples/time_series_scaling.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Time Series Scaling</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../examples/automatic_hyperparameter_tuning.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Hyperparameter Optimization</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../examples/predictinsample.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Predict Insample</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../examples/save_load_models.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Save and Load Models</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../examples/getting_started_complete.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">End to End Walkthrough</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../examples/neuralforecast_map.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">NeuralForecast map</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../examples/how_to_add_models.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">How to add new Models to NeuralForecast</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="false">
 <span class="menu-text">Tutorials</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../examples/signal_decomposition.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Interpretable Decompositions</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../examples/uncertaintyintervals.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Probabilistic Forecasts</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../examples/longhorizon_with_nhits.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Long-Horizon Forecast</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../examples/forecasting_tft.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">TFT: Temporal Fusion Transformer</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../examples/longhorizon_probabilistic.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Probabilistic Long-Horizon</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../examples/longhorizon_with_transformers.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Transformer models</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../examples/intermittentdata.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Intermittent/Sparse Series M5</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../examples/robust_regression.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Outlier Robust Forecasting</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../examples/electricitypeakforecasting.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Detect Demand Peaks</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../examples/hierarchicalnetworks.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Hierarchical Forecast</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../examples/transfer_learning.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Transfer Learning</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../examples/temporal_classifiers.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Temporal Classification</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../examples/predictive_maintenance.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Predictive Maintenance</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../examples/statsmlneuralmethods.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Statistical, Machine Learning and Neural Forecasting methods</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../examples/models_intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">NeuralForecast‚Äôs Contents</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="false">
 <span class="menu-text">API Reference</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../core.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span style="color:DarkOrange"> Core </span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../models.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span style="color:DarkOrange"> Models </span></span></a>
  </div>
</li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="false">
 <span class="menu-text">Models‚Äô Documentation</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="false">
 <span class="menu-text">A. RNN-Based</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth3 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../models.rnn.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">RNN</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../models.gru.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">GRU</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../models.lstm.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">LSTM</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../models.dilated_rnn.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Dilated RNN</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../models.tcn.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">TCN</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../models.deepar.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">DeepAR</span></a>
  </div>
</li>
      </ul>
  </li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" aria-expanded="false">
 <span class="menu-text">B. MLP-Based</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-6" class="collapse list-unstyled sidebar-section depth3 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../models.mlp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">MLP</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../models.nhits.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">NHITS</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../models.nbeats.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">NBEATS</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../models.nbeatsx.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">NBEATSx</span></a>
  </div>
</li>
      </ul>
  </li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" aria-expanded="false">
 <span class="menu-text">C. Transformer-Based</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-7" class="collapse list-unstyled sidebar-section depth3 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../models.tft.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">TFT</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../models.vanillatransformer.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Vanilla Transformer</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../models.informer.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Informer</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../models.autoformer.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Autoformer</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../models.patchtst.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">PatchTST</span></a>
  </div>
</li>
      </ul>
  </li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-8" aria-expanded="false">
 <span class="menu-text">D. CNN-Based</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-8" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-8" class="collapse list-unstyled sidebar-section depth3 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../models.timesnet.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">TimesNet</span></a>
  </div>
</li>
      </ul>
  </li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-9" aria-expanded="false">
 <span class="menu-text">E. Multivariate</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-9" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-9" class="collapse list-unstyled sidebar-section depth3 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../models.hint.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">HINT</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../models.stemgnn.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">StemGNN</span></a>
  </div>
</li>
      </ul>
  </li>
      </ul>
  </li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-10" aria-expanded="false">
 <span class="menu-text">Train/Evaluation</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-10" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-10" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../losses.pytorch.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">PyTorch Losses</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../losses.numpy.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">NumPy Evaluation</span></a>
  </div>
</li>
      </ul>
  </li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-11" aria-expanded="false">
 <span class="menu-text">Common Components</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-11" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-11" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../common.base_auto.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Hyperparameter Optimization</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../common.base_recurrent.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">BaseRecurrent</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../common.base_windows.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">BaseWindows</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../common.scalers.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">TemporalNorm</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../common.modules.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">NN Modules</span></a>
  </div>
</li>
      </ul>
  </li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-12" aria-expanded="false">
 <span class="menu-text">Utils</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-12" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-12" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../tsdataset.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">PyTorch Dataset/Loader</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../utils.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Example Data</span></a>
  </div>
</li>
      </ul>
  </li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-13" aria-expanded="false">
 <span class="menu-text">Community</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-13" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-13" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
 <span class="menu-text">Contributing</span>
  </li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction">Introduction</a>
  <ul class="collapse">
  <li><a href="#example-simplified-mlp-model" id="toc-example-simplified-mlp-model" class="nav-link" data-scroll-target="#example-simplified-mlp-model">Example: simplified MLP model</a></li>
  </ul></li>
  <li><a href="#preliminaries" id="toc-preliminaries" class="nav-link" data-scroll-target="#preliminaries">0. Preliminaries</a></li>
  <li><a href="#inherit-the-base-class-basewindows" id="toc-inherit-the-base-class-basewindows" class="nav-link" data-scroll-target="#inherit-the-base-class-basewindows">1. Inherit the Base Class (<code>BaseWindows</code>)</a>
  <ul class="collapse">
  <li><a href="#a.-sampling-process" id="toc-a.-sampling-process" class="nav-link" data-scroll-target="#a.-sampling-process">a. Sampling process</a></li>
  <li><a href="#b.-basewindows-hyperparameters" id="toc-b.-basewindows-hyperparameters" class="nav-link" data-scroll-target="#b.-basewindows-hyperparameters">b. <code>BaseWindows</code>‚Äô hyperparameters</a></li>
  <li><a href="#c.-input-and-output-batch-shapes" id="toc-c.-input-and-output-batch-shapes" class="nav-link" data-scroll-target="#c.-input-and-output-batch-shapes">c.&nbsp;Input and Output batch shapes</a></li>
  <li><a href="#d.-basewindows-methods" id="toc-d.-basewindows-methods" class="nav-link" data-scroll-target="#d.-basewindows-methods">d.&nbsp;<code>BaseWindows</code>‚Äô methods</a></li>
  </ul></li>
  <li><a href="#create-the-model-file-and-class" id="toc-create-the-model-file-and-class" class="nav-link" data-scroll-target="#create-the-model-file-and-class">2. Create the model file and class</a>
  <ul class="collapse">
  <li><a href="#a.-model-class" id="toc-a.-model-class" class="nav-link" data-scroll-target="#a.-model-class">a. Model class</a></li>
  <li><a href="#b.-tests-and-documentation" id="toc-b.-tests-and-documentation" class="nav-link" data-scroll-target="#b.-tests-and-documentation">b. Tests and documentation</a></li>
  <li><a href="#c.-export-the-new-model-to-the-library-with-nbdev" id="toc-c.-export-the-new-model-to-the-library-with-nbdev" class="nav-link" data-scroll-target="#c.-export-the-new-model-to-the-library-with-nbdev">c.&nbsp;Export the new model to the library with <code>nbdev</code></a></li>
  </ul></li>
  <li><a href="#core-class-and-additional-files" id="toc-core-class-and-additional-files" class="nav-link" data-scroll-target="#core-class-and-additional-files">3. Core class and additional files</a></li>
  <li><a href="#upload-to-github" id="toc-upload-to-github" class="nav-link" data-scroll-target="#upload-to-github">4. Upload to GitHub</a></li>
  <li><a href="#quick-checklist" id="toc-quick-checklist" class="nav-link" data-scroll-target="#quick-checklist">Quick Checklist</a></li>
  </ul>
<div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.com/Nixtla/neuralforecast/issues/new" class="toc-action">Report an issue</a></p></div></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">How to add new Models to NeuralForecast</h1>
</div>

<div>
  <div class="description">
    Tutorial on how to add new models to NeuralForecast
  </div>
</div>


<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Prerequisites
</div>
</div>
<div class="callout-body-container callout-body">
<p>This Guide assumes advanced familiarity with NeuralForecast.</p>
<p>We highly recommend reading first the Getting Started and the NeuralForecast Map tutorials!</p>
<p>Additionally, refer to the <a href="https://github.com/Nixtla/neuralforecast/blob/main/CONTRIBUTING.md">CONTRIBUTING guide</a> for the basics how to contribute to NeuralForecast.</p>
</div>
</div>
<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p>This tutorial is aimed at contributors who want to add a new model to the NeuralForecast library. The library‚Äôs existing modules handle optimization, training, selection, and evaluation of deep learning models. The <code>core</code> class simplifies building entire pipelines, both for industry and academia, on any dataset, with user-friendly methods such as <code>fit</code> and <code>predict</code>.</p>
<h4 style="text-align: center;" class="anchored">
Adding a new model to NeuralForecast is simpler than building a new PyTorch model from scratch. You only need to write the forward method.
</h4>
<p><strong>It has the following additional advantages:</strong></p>
<ul>
<li>Existing modules in NeuralForecast already implement the essential training and evaluating aspects for deep learning models.</li>
<li>Integrated with PyTorch-Lightning and Tune libraries for efficient optimization and distributed computation.</li>
<li>The <code>BaseModel</code> classes provide common optimization components, such as early stopping and learning rate schedulers.</li>
<li>Automatic performance tests are scheduled on Github to ensure quality standards.</li>
<li>Users can easily compare the performance and computation of the new model with existing models.</li>
<li>Opportunity for exposure to a large community of users and contributors.</li>
</ul>
<section id="example-simplified-mlp-model" class="level3">
<h3 class="anchored" data-anchor-id="example-simplified-mlp-model">Example: simplified MLP model</h3>
<p>We will present the tutorial following an example on how to add a simplified version of the current <a href="https://Nixtla.github.io/neuralforecast/models.mlp.html#mlp"><code>MLP</code></a> model, which does not include exogenous covariates.</p>
<p>At a given timestamp <span class="math inline">\(t\)</span>, the <a href="https://Nixtla.github.io/neuralforecast/models.mlp.html#mlp"><code>MLP</code></a> model will forecast the next <span class="math inline">\(h\)</span> values of the univariate target time, <span class="math inline">\(Y_{t+1:t+h}\)</span>, using as inputs the last <span class="math inline">\(L\)</span> historical values, given by <span class="math inline">\(Y_{t-L:t}\)</span>. The following figure presents a diagram of the model.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../imgs_models/mlp.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Figure 1. Three layer MLP with autorregresive inputs.</figcaption>
</figure>
</div>
</section>
</section>
<section id="preliminaries" class="level2">
<h2 class="anchored" data-anchor-id="preliminaries">0. Preliminaries</h2>
<p>Follow our tutorial on contributing <a href="https://github.com/Nixtla/neuralforecast/blob/main/CONTRIBUTING.md">here</a> to set up your development environment.</p>
<p>Here is a short list of the most important steps:</p>
<ol type="1">
<li>Create a fork of the <code>neuralforecast</code> library.</li>
<li>Clone the fork to your computer.</li>
<li>Set an environment with the <code>neuralforecast</code> library, core dependencies, and <code>nbdev</code> package to code your model in an interactive notebook.</li>
</ol>
</section>
<section id="inherit-the-base-class-basewindows" class="level2">
<h2 class="anchored" data-anchor-id="inherit-the-base-class-basewindows">1. Inherit the Base Class (<code>BaseWindows</code>)</h2>
<p>The library contains <strong>three</strong> types of base models: <code>BaseWindows</code>, <code>BaseRecurrent</code>, and <code>BaseMultivariate</code>. In this tutorial, we will focus on the <code>BaseWindows</code> class, which is the most common type of model in the library, with models such as <a href="https://Nixtla.github.io/neuralforecast/models.nbeats.html#nbeats"><code>NBEATS</code></a>, <a href="https://Nixtla.github.io/neuralforecast/models.nhits.html#nhits"><code>NHITS</code></a>, <a href="https://Nixtla.github.io/neuralforecast/models.tft.html#tft"><code>TFT</code></a>, and <a href="https://Nixtla.github.io/neuralforecast/models.patchtst.html#patchtst"><code>PatchTST</code></a>. The main difference between the three types is the sampling procedure and input batch for the <code>forward</code> method, which determines the type of model.</p>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>If you want to add a <code>BaseRecurrent</code> or <code>BaseMultivariate</code> model, please add an issue in our github.</p>
</div>
</div>
<section id="a.-sampling-process" class="level3">
<h3 class="anchored" data-anchor-id="a.-sampling-process">a. Sampling process</h3>
<p>During training, the base class receives a sample of time series of the dataset from the <a href="https://Nixtla.github.io/neuralforecast/tsdataset.html#timeseriesloader"><code>TimeSeriesLoader</code></a> module. The <code>BaseWindows</code> models will sample individual windows of size <code>input_size+h</code>, starting from random timestamps.</p>
</section>
<section id="b.-basewindows-hyperparameters" class="level3">
<h3 class="anchored" data-anchor-id="b.-basewindows-hyperparameters">b. <code>BaseWindows</code>‚Äô hyperparameters</h3>
<p>Get familiar with the hyperparameters specified in the base class, including <code>h</code> (horizon), <code>input_size</code>, and optimization hyperparameters such as <code>learning_rate</code>, <code>max_steps</code>, among others. The following list presents the hyperparameters related to the sampling of windows:</p>
<ul>
<li><code>h</code> (h): number of future values to predict.</li>
<li><code>input_size</code> (L): number of historic values to use as input for the model.</li>
<li><code>batch_size</code> (bs): number of time series sampled by the loader during training.</li>
<li><code>valid_batch_size</code> (v_bs): number of time series sampled by the loader during inference (validation and test).</li>
<li><code>windows_batch_size</code> (w_bs): number of individual windows sampled during training (from the previous time series) to form the batch.</li>
<li><code>inference_windows_batch_size</code> (i_bs): number of individual windows sampled during inference to form each batch. Used to control the GPU memory.</li>
</ul>
</section>
<section id="c.-input-and-output-batch-shapes" class="level3">
<h3 class="anchored" data-anchor-id="c.-input-and-output-batch-shapes">c.&nbsp;Input and Output batch shapes</h3>
<p>The <code>forward</code> method receives a batch of data in a dictionary with the following keys:</p>
<ul>
<li><code>insample_y</code>: historic values of the time series.</li>
<li><code>insample_mask</code>: mask indicating the available values of the time series (1 if available, 0 if missing).</li>
<li><code>futr_exog</code>: future exogenous covariates (if any).</li>
<li><code>hist_exog</code>: historic exogenous covariates (if any).</li>
<li><code>stat_exog</code>: static exogenous covariates (if any).</li>
</ul>
<p>The following table presents the shape for each tensor:</p>
<table class="table">
<thead>
<tr class="header">
<th><code>tensor</code></th>
<th><code>BaseWindows</code></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>insample_y</code></td>
<td>(<code>w_bs</code>, <code>L</code>)</td>
</tr>
<tr class="even">
<td><code>insample_mask</code></td>
<td>(<code>w_bs</code>, <code>L</code>)</td>
</tr>
<tr class="odd">
<td><code>futr_exog</code></td>
<td>(<code>w_bs</code>, <code>L</code>+<code>h</code>, <code>n_f</code>)</td>
</tr>
<tr class="even">
<td><code>hist_exog</code></td>
<td>(<code>w_bs</code>, <code>L</code>, <code>n_h</code>)</td>
</tr>
<tr class="odd">
<td><code>stat_exog</code></td>
<td>(<code>w_bs</code>,<code>n_s</code>)</td>
</tr>
</tbody>
</table>
<p>The <code>forward</code> function should return a single tensor with the forecasts of the next <code>h</code> timestamps for each window. Use the attributes of the <code>loss</code> class to automatically parse the output to the correct shape (see the example below).</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>Since we are using <code>nbdev</code>, you can easily add prints to the code and see the shapes of the tensors during training.</p>
</div>
</div>
</section>
<section id="d.-basewindows-methods" class="level3">
<h3 class="anchored" data-anchor-id="d.-basewindows-methods">d.&nbsp;<code>BaseWindows</code>‚Äô methods</h3>
<p>The <code>BaseWindows</code> class contains several common methods for all windows-based models, simplifying the development of new models by preventing code duplication. The most important methods of the class are:</p>
<ul>
<li><code>_create_windows</code>: parses the time series from the <a href="https://Nixtla.github.io/neuralforecast/tsdataset.html#timeseriesloader"><code>TimeSeriesLoader</code></a> into individual windows of size <code>input_size+h</code>.</li>
<li><code>_normalization</code>: normalizes each window based on the <code>scaler</code> type.</li>
<li><code>_inv_normalization</code>: inverse normalization of the forecasts.</li>
<li><code>training_step</code>: training step of the model, called by PyTorch-Lightning‚Äôs <code>Trainer</code> class during training (<code>fit</code> method).</li>
<li><code>validation_step</code>: validation step of the model, called by PyTorch-Lightning‚Äôs <code>Trainer</code> class during validation.</li>
<li><code>predict_step</code>: prediction step of the model, called by PyTorch-Lightning‚Äôs <code>Trainer</code> class during inference (<code>predict</code> method).</li>
</ul>
</section>
</section>
<section id="create-the-model-file-and-class" class="level2">
<h2 class="anchored" data-anchor-id="create-the-model-file-and-class">2. Create the model file and class</h2>
<p>Once familiar with the basics of the <code>BaseWindows</code> class, the next step is creating your particular model.</p>
<p>The main steps are:</p>
<ol type="1">
<li>Create the file in the <code>nbs</code> folder (https://github.com/Nixtla/neuralforecast/tree/main/nbs). It should be named <code>models.YOUR_MODEL_NAME.ipynb</code>.</li>
<li>Add the header of the <code>nbdev</code> file.</li>
<li>Import libraries in the file.</li>
<li>Define the <code>__init__</code> method with the model‚Äôs inherited and particular hyperparameters and instantiate the architecture.</li>
<li>Define the <code>forward</code> method, which recieves the input batch dictionary and returns the forecast.</li>
</ol>
<section id="a.-model-class" class="level3">
<h3 class="anchored" data-anchor-id="a.-model-class">a. Model class</h3>
<p>First, add the following <strong>two cells</strong> on top of the <code>nbdev</code> file.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co">#| default_exp models.mlp</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>Change <code>mlp</code> to your model‚Äôs name, using lowercase and underscores. When you later run <code>nbdev_export</code>, it will create a <code>YOUR_MODEL.py</code> script in the <code>neuralforecast/models/</code> directory.</p>
</div>
</div>
<div class="sourceCode" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co">#| hide</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>load_ext autoreload</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>autoreload <span class="dv">2</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Next, add the dependencies of the model.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co">#| export</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> Optional</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch.nn <span class="im">as</span> nn</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> neuralforecast.losses.pytorch <span class="im">import</span> MAE</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> neuralforecast.common._base_windows <span class="im">import</span> BaseWindows</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>Don‚Äôt forget to add the <code>#| export</code> tag on this cell.</p>
</div>
</div>
<p>Next, create the class with the <code>init</code> and <code>forward</code> methods. The following example shows the example for the simplified <a href="https://Nixtla.github.io/neuralforecast/models.mlp.html#mlp"><code>MLP</code></a> model. We explain important details after the code.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co">#| export</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MLP(BaseWindows): <span class="co"># &lt;&lt;---- Inherits from BaseWindows</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>,</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>                 <span class="co"># Inhereted hyperparameters with no defaults</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>                 h,</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>                 input_size,</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>                 <span class="co"># Model specific hyperparameters</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>                 num_layers <span class="op">=</span> <span class="dv">2</span>,</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>                 hidden_size <span class="op">=</span> <span class="dv">1024</span>,</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>                 <span class="co"># Inhereted hyperparameters with defaults</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>                 exclude_insample_y <span class="op">=</span> <span class="va">False</span>,</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>                 loss <span class="op">=</span> MAE(),</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>                 valid_loss <span class="op">=</span> <span class="va">None</span>,</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>                 max_steps: <span class="bu">int</span> <span class="op">=</span> <span class="dv">1000</span>,</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>                 learning_rate: <span class="bu">float</span> <span class="op">=</span> <span class="fl">1e-3</span>,</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>                 num_lr_decays: <span class="bu">int</span> <span class="op">=</span> <span class="op">-</span><span class="dv">1</span>,</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>                 early_stop_patience_steps: <span class="bu">int</span> <span class="op">=-</span><span class="dv">1</span>,</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>                 val_check_steps: <span class="bu">int</span> <span class="op">=</span> <span class="dv">100</span>,</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>                 batch_size: <span class="bu">int</span> <span class="op">=</span> <span class="dv">32</span>,</span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>                 valid_batch_size: Optional[<span class="bu">int</span>] <span class="op">=</span> <span class="va">None</span>,</span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>                 windows_batch_size <span class="op">=</span> <span class="dv">1024</span>,</span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>                 inference_windows_batch_size <span class="op">=</span> <span class="op">-</span><span class="dv">1</span>,</span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>                 step_size: <span class="bu">int</span> <span class="op">=</span> <span class="dv">1</span>,</span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>                 scaler_type: <span class="bu">str</span> <span class="op">=</span> <span class="st">'identity'</span>,</span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>                 random_seed: <span class="bu">int</span> <span class="op">=</span> <span class="dv">1</span>,</span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>                 num_workers_loader: <span class="bu">int</span> <span class="op">=</span> <span class="dv">0</span>,</span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>                 drop_last_loader: <span class="bu">bool</span> <span class="op">=</span> <span class="va">False</span>,</span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>                 <span class="op">**</span>trainer_kwargs):</span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Inherit BaseWindows class</span></span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a>    <span class="bu">super</span>(MLP, <span class="va">self</span>).<span class="fu">__init__</span>(h<span class="op">=</span>h,</span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a>                              input_size<span class="op">=</span>input_size,</span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a>                              ..., <span class="co"># &lt;&lt;--- Add all inhereted hyperparameters</span></span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a>                              random_seed<span class="op">=</span>random_seed,</span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a>                              <span class="op">**</span>trainer_kwargs)</span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Architecture</span></span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.num_layers <span class="op">=</span> num_layers</span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.hidden_size <span class="op">=</span> hidden_size</span>
<span id="cb4-39"><a href="#cb4-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-40"><a href="#cb4-40" aria-hidden="true" tabindex="-1"></a>    <span class="co"># MultiLayer Perceptron</span></span>
<span id="cb4-41"><a href="#cb4-41" aria-hidden="true" tabindex="-1"></a>    layers <span class="op">=</span> [nn.Linear(in_features<span class="op">=</span>input_size, out_features<span class="op">=</span>hidden_size)]</span>
<span id="cb4-42"><a href="#cb4-42" aria-hidden="true" tabindex="-1"></a>    layers <span class="op">+=</span> [nn.ReLU()]</span>
<span id="cb4-43"><a href="#cb4-43" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(num_layers <span class="op">-</span> <span class="dv">1</span>):</span>
<span id="cb4-44"><a href="#cb4-44" aria-hidden="true" tabindex="-1"></a>        layers <span class="op">+=</span> [nn.Linear(in_features<span class="op">=</span>hidden_size, out_features<span class="op">=</span>hidden_size)]</span>
<span id="cb4-45"><a href="#cb4-45" aria-hidden="true" tabindex="-1"></a>        layers <span class="op">+=</span> [nn.ReLU()]</span>
<span id="cb4-46"><a href="#cb4-46" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.mlp <span class="op">=</span> nn.ModuleList(layers)</span>
<span id="cb4-47"><a href="#cb4-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-48"><a href="#cb4-48" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Adapter with Loss dependent dimensions</span></span>
<span id="cb4-49"><a href="#cb4-49" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.out <span class="op">=</span> nn.Linear(in_features<span class="op">=</span>hidden_size, </span>
<span id="cb4-50"><a href="#cb4-50" aria-hidden="true" tabindex="-1"></a>                         out_features<span class="op">=</span>h <span class="op">*</span> <span class="va">self</span>.loss.outputsize_multiplier) <span class="co">## &lt;&lt;--- Use outputsize_multiplier to adjust output size</span></span>
<span id="cb4-51"><a href="#cb4-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-52"><a href="#cb4-52" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, windows_batch): <span class="co"># &lt;&lt;--- Receives windows_batch dictionary</span></span>
<span id="cb4-53"><a href="#cb4-53" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Parse windows_batch</span></span>
<span id="cb4-54"><a href="#cb4-54" aria-hidden="true" tabindex="-1"></a>        insample_y <span class="op">=</span> windows_batch[<span class="st">'insample_y'</span>].clone()</span>
<span id="cb4-55"><a href="#cb4-55" aria-hidden="true" tabindex="-1"></a>        <span class="co"># MLP</span></span>
<span id="cb4-56"><a href="#cb4-56" aria-hidden="true" tabindex="-1"></a>        y_pred <span class="op">=</span> <span class="va">self</span>.mlp(y_pred)</span>
<span id="cb4-57"><a href="#cb4-57" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Reshape and map to loss domain</span></span>
<span id="cb4-58"><a href="#cb4-58" aria-hidden="true" tabindex="-1"></a>        y_pred <span class="op">=</span> y_pred.reshape(batch_size, <span class="va">self</span>.h, <span class="va">self</span>.loss.outputsize_multiplier)</span>
<span id="cb4-59"><a href="#cb4-59" aria-hidden="true" tabindex="-1"></a>        y_pred <span class="op">=</span> <span class="va">self</span>.loss.domain_map(y_pred)</span>
<span id="cb4-60"><a href="#cb4-60" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> y_pred</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>Don‚Äôt forget to add the <code>#| export</code> tag on each cell.</li>
<li>Larger architectures, such as Transformers, might require splitting the <code>forward</code> by using intermediate functions.</li>
</ul>
</div>
</div>
<section id="important-notes" class="level4">
<h4 class="anchored" data-anchor-id="important-notes">Important notes</h4>
<p>The base class has many hyperparameters, and models must have default values for all of them (except <code>h</code> and <code>input_size</code>). If you are unsure of what default value to use, we recommend copying the default values from existing models for most optimization and sampling hyperparameters. You can change the default values later at any time.</p>
<p>The <code>reshape</code> method at the end of the <code>forward</code> step is used to adjust the output shape. The <code>loss</code> class contains an <code>outputsize_multiplier</code> attribute to automatically adjust the output size of the forecast depending on the <code>loss</code>. For example, for the Multi-quantile loss (<a href="https://Nixtla.github.io/neuralforecast/losses.pytorch.html#mqloss"><code>MQLoss</code></a>), the model needs to output each quantile for each horizon.</p>
<p><strong>Finally, always include <code>y_pred = self.loss.domain_map(y_pred)</code> at the end of the <code>forward</code></strong>. This is necessary to map the output to the domain (and shape) of the loss function. For example, if the loss function is the <a href="https://Nixtla.github.io/neuralforecast/losses.pytorch.html#mae"><code>MAE</code></a>, it maps the output of shape <code>(batch_size, h, 1)</code> to <code>(batch_size, h)</code>.</p>
</section>
</section>
<section id="b.-tests-and-documentation" class="level3">
<h3 class="anchored" data-anchor-id="b.-tests-and-documentation">b. Tests and documentation</h3>
<p><code>nbdev</code> allows for testing and documenting the model during the development process. It allows users to iterate the development within the notebook, testing the code in the same environment. Refer to existing models, such as the complete MLP model <a href="https://github.com/Nixtla/neuralforecast/blob/main/nbs/models.mlp.ipynb">here</a>. These files already contain the tests, documentation, and usage examples that were used during the development process.</p>
</section>
<section id="c.-export-the-new-model-to-the-library-with-nbdev" class="level3">
<h3 class="anchored" data-anchor-id="c.-export-the-new-model-to-the-library-with-nbdev">c.&nbsp;Export the new model to the library with <code>nbdev</code></h3>
<p>Following the CONTRIBUTING guide, the next step is to export the new model from the development notebook to the <code>neuralforecast</code> folder with the actual scripts.</p>
<p>To export the model, run <code>nbdev_export</code> in your terminal. You should see a new file with your model in the <code>neuralforecast/models/</code> folder.</p>
</section>
</section>
<section id="core-class-and-additional-files" class="level2">
<h2 class="anchored" data-anchor-id="core-class-and-additional-files">3. Core class and additional files</h2>
<p>Finally, add the model to the <code>core</code> class and additional files:</p>
<ol type="1">
<li><p>Manually add the model in the following <a href="https://github.com/Nixtla/neuralforecast/blob/main/neuralforecast/models/__init__.py">init file</a>.</p></li>
<li><p>Add the model to the <code>core</code> class, using the <code>nbdev</code> file <a href="https://github.com/Nixtla/neuralforecast/blob/main/nbs/core.ipynb">here</a>:</p>
<ol type="a">
<li>Add the model to the initial model list:</li>
</ol>
<div class="sourceCode" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> neuralforecast.models <span class="im">import</span> (</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>GRU, LSTM, RNN, TCN, DilatedRNN,</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>MLP, NHITS, NBEATS, NBEATSx,</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>TFT, VanillaTransformer,</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>Informer, Autoformer, FEDformer,</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>StemGNN, PatchTST</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ol start="2" type="a">
<li>Add the model to the <code>MODEL_FILENAME_DICT</code> dictionary (used for the <code>save</code> and <code>load</code> functions).</li>
</ol></li>
</ol>
</section>
<section id="upload-to-github" class="level2">
<h2 class="anchored" data-anchor-id="upload-to-github">4. Upload to GitHub</h2>
<p>Congratulations! The model is ready to be used in the library following the steps above.</p>
<p>Follow our contributing guide‚Äôs final steps to upload the model to GitHub: <a href="https://github.com/Nixtla/neuralforecast/blob/main/CONTRIBUTING.md">here</a>.</p>
<p>One of the maintainers will review the PR, request changes if necessary, and merge it into the library.</p>
</section>
<section id="quick-checklist" class="level2">
<h2 class="anchored" data-anchor-id="quick-checklist">Quick Checklist</h2>
<ul>
<li>Get familiar with the <code>BaseWindows</code> class hyperparameters and input/output shapes of the <code>forward</code> method.</li>
<li>Create the notebook with your model class in the <code>nbs</code> folder: <code>models.YOUR_MODEL_NAME.ipynb</code></li>
<li>Add the header and import libraries.</li>
<li>Implement <code>init</code> and <code>forward</code> methods.</li>
<li>Export model with <code>nbdev_export</code>.</li>
<li>Add model to this <a href="https://github.com/Nixtla/neuralforecast/blob/main/neuralforecast/models/__init__.py">init file</a>.</li>
<li>Add the model to the <code>core</code> class <a href="https://github.com/Nixtla/neuralforecast/blob/main/nbs/core.ipynb">here</a>.</li>
<li>Follow the CONTRIBUTING guide to create the PR to upload the model.</li>
</ul>


</section>

<p>Give us a ‚≠ê&nbsp;on <a href="https://github.com/nixtla/neuralforecast">Github</a></p></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "Óßã";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>